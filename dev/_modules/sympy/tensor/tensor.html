

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sympy.tensor.tensor &mdash; SymPy 0.7.2-git documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-core.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-autocomplete.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.7.2-git',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/utilities.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/external/classy.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-core.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-autocomplete.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-sphinx.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../_static/SymPy-Favicon.ico"/>
    <link rel="top" title="SymPy 0.7.2-git documentation" href="../../../index.html" />
    <link rel="up" title="sympy" href="../../sympy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SymPy 0.7.2-git documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../sympy.html" accesskey="U">sympy</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for sympy.tensor.tensor</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines tensors with abstract index notation.</span>

<span class="sd">The abstract index notation has been first formalized by Penrose.</span>

<span class="sd">Tensor indices are formal objects, with a tensor type; there is no</span>
<span class="sd">notion of index range, it is only possible to assign the dimension,</span>
<span class="sd">used to trace the Kronecker delta; the dimension can be a Symbol.</span>

<span class="sd">The Einstein summation convention is used.</span>
<span class="sd">The covariant indices are indicated with a minus sign in front of the index.</span>

<span class="sd">For instance the tensor ``t = p(a)*A(b,c)*q(-c)`` has the index ``c``</span>
<span class="sd">contracted.</span>

<span class="sd">A tensor expression ``t`` can be called; called with its</span>
<span class="sd">indices in sorted order it is equal to itself:</span>
<span class="sd">in the above example ``t(a, b) == t``;</span>
<span class="sd">one can call ``t`` with different indices; ``t(c, d) == p(c)*A(d,a)*q(-a)``.</span>

<span class="sd">The contracted indices are dummy indices, internally they have no name,</span>
<span class="sd">the indices being represented by a graph-like structure.</span>

<span class="sd">Tensors are put in canonical form using ``canon_bp``, which uses</span>
<span class="sd">the Butler-Portugal algorithm for canonicalization using the monoterm</span>
<span class="sd">symmetries of the tensors.</span>

<span class="sd">If there is a (anti)symmetric metric, the indices can be raised and</span>
<span class="sd">lowered when the tensor is put in canonical form.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">sympy.core</span> <span class="kn">import</span> <span class="n">Basic</span><span class="p">,</span> <span class="n">sympify</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">Mul</span><span class="p">,</span> <span class="n">S</span>
<span class="kn">from</span> <span class="nn">sympy.core.symbol</span> <span class="kn">import</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">symbols</span>
<span class="kn">from</span> <span class="nn">sympy.combinatorics.tensor_can</span> <span class="kn">import</span> <span class="n">get_symmetric_group_sgs</span><span class="p">,</span> <span class="n">bsgs_direct_product</span><span class="p">,</span> <span class="n">canonicalize</span><span class="p">,</span> <span class="n">riemann_bsgs</span>

<div class="viewcode-block" id="_TensorManager"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager">[docs]</a><span class="k">class</span> <span class="nc">_TensorManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to manage tensor properties.</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    Tensors belong to tensor commutation groups; each group has a label</span>
<span class="sd">    ``comm``; there are predefined labels:</span>

<span class="sd">    ``0``   tensors commuting with any other tensor</span>

<span class="sd">    ``1``   tensors anticommuting among themselves</span>

<span class="sd">    ``2``   tensors not commuting, apart with those with ``comm=0``</span>

<span class="sd">    Other groups can be defined using ``set_comm``; tensors in those</span>
<span class="sd">    groups commute with those with ``comm=0``; by default they</span>
<span class="sd">    do not commute with any other group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm_init</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_comm_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm_i2symbol</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span>

<div class="viewcode-block" id="_TensorManager.comm_symbols2i"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager.comm_symbols2i">[docs]</a>    <span class="k">def</span> <span class="nf">comm_symbols2i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the commutation group number corresponding to ``i``</span>

<span class="sd">        ``i`` can be a symbol or a number or a string</span>

<span class="sd">        If ``i`` is not already defined its commutation group number</span>
<span class="sd">        is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm_i2symbol</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">return</span> <span class="n">n</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="_TensorManager.comm_i2symbol"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager.comm_i2symbol">[docs]</a>    <span class="k">def</span> <span class="nf">comm_i2symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the symbol corresponding to the commutation group number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_i2symbol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="_TensorManager.set_comm"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager.set_comm">[docs]</a>    <span class="k">def</span> <span class="nf">set_comm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the commutation parameter ``c`` for commutation groups ``i, j``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        i, j : symbols representing commutation groups</span>

<span class="sd">        c  :  group commutation number</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>

<span class="sd">        ``i, j`` can be symbols, strings or numbers,</span>
<span class="sd">        apart from ``0, 1`` and ``2`` which are reserved respectively</span>
<span class="sd">        for commuting, anticommuting tensors and tensors not commuting</span>
<span class="sd">        with any other group apart with the commuting tensors.</span>
<span class="sd">        For the remaining cases, use this method to set the commutation rules;</span>
<span class="sd">        by default ``c=None``.</span>

<span class="sd">        The group commutation number ``c`` is assigned in corrispondence</span>
<span class="sd">        to the group commutation symbols; it can be</span>

<span class="sd">        0        commuting</span>

<span class="sd">        1        anticommuting</span>

<span class="sd">        None     no commutation property</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        ``G`` and ``GH`` do not commute with themselves and commute with</span>
<span class="sd">        each other; A is commuting.</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead, TensorManager</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i0,i1,i2,i3,i4 = tensor_indices(&#39;i0:5&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A = tensorhead(&#39;A&#39;, [Lorentz], [[1]])</span>
<span class="sd">        &gt;&gt;&gt; G = tensorhead(&#39;G&#39;, [Lorentz], [[1]], &#39;Gcomm&#39;)</span>
<span class="sd">        &gt;&gt;&gt; GH = tensorhead(&#39;GH&#39;, [Lorentz], [[1]], &#39;GHcomm&#39;)</span>
<span class="sd">        &gt;&gt;&gt; TensorManager.set_comm(&#39;Gcomm&#39;, &#39;GHcomm&#39;, 0)</span>
<span class="sd">        &gt;&gt;&gt; (GH(i1)*G(i0)).canon_bp()</span>
<span class="sd">        G(i0)*GH(i1)</span>
<span class="sd">        &gt;&gt;&gt; (G(i1)*G(i0)).canon_bp()</span>
<span class="sd">        G(i1)*G(i0)</span>
<span class="sd">        &gt;&gt;&gt; (G(i1)*A(i0)).canon_bp()</span>
<span class="sd">        A(i0)*G(i1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;`c` can assume only the values 0, 1 or None&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm_i2symbol</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm_i2symbol</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm_symbols2i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">ni</span><span class="p">][</span><span class="n">nj</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">nj</span><span class="p">][</span><span class="n">ni</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="_TensorManager.set_comms"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager.set_comms">[docs]</a>    <span class="k">def</span> <span class="nf">set_comms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the commutation group numbers ``c`` for symbols ``i, j``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        args : sequence of ``(i, j, c)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_comm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="_TensorManager.get_comm"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager.get_comm">[docs]</a>    <span class="k">def</span> <span class="nf">get_comm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the commutation parameter for commutation group numbers ``i, j``</span>

<span class="sd">        see ``_TensorManager.set_comm``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="_TensorManager.clear"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor._TensorManager.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the TensorManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm_init</span><span class="p">()</span>

</div></div>
<span class="n">TensorManager</span> <span class="o">=</span> <span class="n">_TensorManager</span><span class="p">()</span>

<div class="viewcode-block" id="TensorIndexType"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensorIndexType">[docs]</a><span class="k">class</span> <span class="nc">TensorIndexType</span><span class="p">(</span><span class="n">Basic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A TensorIndexType is characterized by its name and its metric.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    name : name of the tensor type</span>

<span class="sd">    metric : metric symmetry or metric object or ``None``</span>


<span class="sd">    dim : dimension, it can be a symbol or an integer or ``None``</span>

<span class="sd">    eps_dim : dimension of the epsilon tensor</span>

<span class="sd">    dummy_fmt : name of the head of dummy indices</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``name``</span>
<span class="sd">    ``metric_name`` : it is &#39;metric&#39; or metric.name</span>
<span class="sd">    ``metric_antisym``</span>
<span class="sd">    ``metric`` : the metric tensor</span>
<span class="sd">    ``delta`` : ``Kronecker delta``</span>
<span class="sd">    ``epsilon`` : the ``Levi-Civita epsilon`` tensor</span>
<span class="sd">    ``dim``</span>
<span class="sd">    ``dim_eps``</span>
<span class="sd">    ``dummy_fmt``</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    The ``metric`` parameter can be:</span>
<span class="sd">    ``metric = False`` symmetric metric (in Riemannian geometry)</span>

<span class="sd">    ``metric = True`` antisymmetric metric (for spinor calculus)</span>

<span class="sd">    ``metric = None``  there is no metric</span>

<span class="sd">    ``metric`` can be an object having ``name`` and ``antisym`` attributes.</span>


<span class="sd">    If there is a metric the metric is used to raise and lower indices.</span>

<span class="sd">    In the case of antisymmetric metric, the following raising and</span>
<span class="sd">    lowering conventions will be adopted:</span>

<span class="sd">    ``psi(a) = g(a, b)*psi(-b); chi(-a) = chi(b)*g(-b, -a)``</span>

<span class="sd">    ``g(-a, b) = delta(-a, b); g(b, -a) = -delta(a, -b)``</span>

<span class="sd">    where ``delta(-a, b) = delta(b, -a)`` is the ``Kronecker delta``</span>
<span class="sd">    (see ``TensorIndex`` for the conventions on indices).</span>

<span class="sd">    If there is no metric it is not possible to raise or lower indices;</span>
<span class="sd">    e.g. the index of the defining representation of ``SU(N)``</span>
<span class="sd">    is &#39;covariant&#39; and the conjugate representation is</span>
<span class="sd">    &#39;contravariant&#39;; for ``N &gt; 2`` they are linearly independent.</span>

<span class="sd">    ``eps_dim`` is by default equal to ``dim``, if the latter is an integer;</span>
<span class="sd">    else it can be assigned (for use in naive dimensional regularization);</span>
<span class="sd">    if ``eps_dim`` is not an integer ``epsilon`` is ``None``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; Lorentz.metric</span>
<span class="sd">    metric(Lorentz,Lorentz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eps_dim</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">dummy_fmt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dummy_fmt</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_dummy_fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%%</span><span class="s">d&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_dummy_fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%%</span><span class="s">d&#39;</span> <span class="o">%</span> <span class="n">dummy_fmt</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">metric_antisym</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="s">&#39;metric&#39;</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">metric_antisym</span> <span class="o">=</span> <span class="n">metric</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">name</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">metric_antisym</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">antisym</span>
            <span class="n">sym2</span> <span class="o">=</span> <span class="n">TensorSymmetry</span><span class="p">(</span><span class="n">get_symmetric_group_sgs</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">metric_antisym</span><span class="p">))</span>
            <span class="n">S2</span> <span class="o">=</span> <span class="n">TensorType</span><span class="p">([</span><span class="n">obj</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">sym2</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">S2</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_dim</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_kronecker_delta</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_eps_dim</span> <span class="o">=</span> <span class="n">eps_dim</span> <span class="k">if</span> <span class="n">eps_dim</span> <span class="k">else</span> <span class="n">dim</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_epsilon</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dim</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eps_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps_dim</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dummy_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy_fmt</span>

    <span class="k">def</span> <span class="nf">get_kronecker_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sym2</span> <span class="o">=</span> <span class="n">TensorSymmetry</span><span class="p">(</span><span class="n">get_symmetric_group_sgs</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="n">TensorType</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">sym2</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">S2</span><span class="p">(</span><span class="s">&#39;KD&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">delta</span>

    <span class="k">def</span> <span class="nf">get_epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps_dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">sym</span> <span class="o">=</span> <span class="n">TensorSymmetry</span><span class="p">(</span><span class="n">get_symmetric_group_sgs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">Sdim</span> <span class="o">=</span> <span class="n">TensorType</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps_dim</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">Sdim</span><span class="p">(</span><span class="s">&#39;Eps&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">epsilon</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
</div>
<div class="viewcode-block" id="TensorIndex"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensorIndex">[docs]</a><span class="k">class</span> <span class="nc">TensorIndex</span><span class="p">(</span><span class="n">Basic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an abstract tensor index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    name : name of the index</span>
<span class="sd">    tensortype : ``TensorIndexType`` of the index</span>
<span class="sd">    is_up :  flag for contravariant index</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``name``</span>
<span class="sd">    ``tensortype``</span>
<span class="sd">    ``is_up``</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    Tensor indices are contracted with the Einstein summation convention.</span>

<span class="sd">    An index can be in contravariant or in covariant form; in the latter</span>
<span class="sd">    case it is represented prepending a ``-`` to the index name.</span>

<span class="sd">    Dummy indices have a name with head given by ``tensortype.dummy_fmt``</span>


<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, TensorIndex, TensorSymmetry, TensorType, get_symmetric_group_sgs</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; i = TensorIndex(&#39;i&#39;, Lorentz); i</span>
<span class="sd">    i</span>
<span class="sd">    &gt;&gt;&gt; sym1 = TensorSymmetry(get_symmetric_group_sgs(1))</span>
<span class="sd">    &gt;&gt;&gt; S1 = TensorType([Lorentz], sym1)</span>
<span class="sd">    &gt;&gt;&gt; A, B = S1(&#39;A,B&#39;)</span>
<span class="sd">    &gt;&gt;&gt; A(i)*B(-i)</span>
<span class="sd">    A(L_0)*B(-L_0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tensortype</span><span class="p">,</span> <span class="n">is_up</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tensortype</span><span class="p">,</span> <span class="n">is_up</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_tensortype</span> <span class="o">=</span> <span class="n">tensortype</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_is_up</span> <span class="o">=</span> <span class="n">is_up</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tensortype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensortype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_up</span>

    <span class="k">def</span> <span class="nf">_pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tensortype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_tensortype</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">TensorIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensortype</span><span class="p">,</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_up</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">t1</span>
</div>
<div class="viewcode-block" id="tensor_indices"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.tensor_indices">[docs]</a><span class="k">def</span> <span class="nf">tensor_indices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns list of tensor indices given their names and their types</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    s : string of comma separated names of indices</span>

<span class="sd">    typ : list of ``TensorIndexType`` of the indices</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; a, b, c, d = tensor_indices(&#39;a,b,c,d&#39;, Lorentz)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;expecting a string&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">TensorIndex</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="TensorSymmetry"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensorSymmetry">[docs]</a><span class="k">class</span> <span class="nc">TensorSymmetry</span><span class="p">(</span><span class="n">Basic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monoterm symmetry of a tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    bsgs : tuple ``(base, sgs)`` BSGS of the symmetry of the tensor</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``base`` : base of the BSGS</span>
<span class="sd">    ``generators`` : generators of the BSGS</span>
<span class="sd">    ``rank`` : rank of the tensor</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    A tensor can have an arbitrary monoterm symmetry provided by its BSGS.</span>
<span class="sd">    Multiterm symmetries, like the cyclic symmetry of the Riemann tensor,</span>
<span class="sd">    are not covered.</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>

<span class="sd">    sympy.combinatorics.tensor_can.get_symmetric_group_sgs</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    Define a symmetric tensor</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, TensorSymmetry, TensorType, get_symmetric_group_sgs</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; sym2 = TensorSymmetry(get_symmetric_group_sgs(2))</span>
<span class="sd">    &gt;&gt;&gt; S2 = TensorType([Lorentz]*2, sym2)</span>
<span class="sd">    &gt;&gt;&gt; V = S2(&#39;V&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">bsgs</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">generators</span> <span class="o">=</span> <span class="n">bsgs</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">generators</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">generators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_hashable_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>

</div>
<span class="k">def</span> <span class="nf">tensorsymmetry</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a ``TensorSymmetry`` object.</span>

<span class="sd">    One can represent a tensor with any monoterm slot symmetry group</span>
<span class="sd">    using a BSGS.</span>

<span class="sd">    ``args`` can be a BSGS</span>
<span class="sd">    ``args[0]``    base</span>
<span class="sd">    ``args[1]``    sgs</span>

<span class="sd">    Usually tensors are in (direct products of) representations</span>
<span class="sd">    of the symmetric group;</span>
<span class="sd">    ``args`` can be a list of lists representing the shapes of Young tableaux</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    For instance:</span>
<span class="sd">    ``[[1]]``       vector</span>
<span class="sd">    ``[[1]*n]``     symmetric tensor of rank ``n``</span>
<span class="sd">    ``[[n]]``       antisymmetric tensor of rank ``n``</span>
<span class="sd">    ``[[2, 2]]``    monoterm slot symmetry of the Riemann tensor</span>
<span class="sd">    ``[[1],[1]]``   vector*vector</span>
<span class="sd">    ``[[2],[1],[1]`` (antisymmetric tensor)*vector*vector</span>

<span class="sd">    Notice that with the shape ``[2, 2]`` we associate only the monoterm</span>
<span class="sd">    symmetries of the Riemann tensor; this is an abuse of notation,</span>
<span class="sd">    since the shape ``[2, 2]`` corresponds usually to the irreducible</span>
<span class="sd">    representation characterized by the monoterm symmetries and by the</span>
<span class="sd">    cyclic symmetry.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    Symmetric tensor using a Young tableau</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, TensorType, tensorsymmetry</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; sym2 = tensorsymmetry([1, 1])</span>
<span class="sd">    &gt;&gt;&gt; S2 = TensorType([Lorentz]*2, sym2)</span>
<span class="sd">    &gt;&gt;&gt; V = S2(&#39;V&#39;)</span>

<span class="sd">    Symmetric tensor using a BSGS</span>
<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorSymmetry, get_symmetric_group_sgs</span>
<span class="sd">    &gt;&gt;&gt; sym2 = tensorsymmetry(*get_symmetric_group_sgs(2))</span>
<span class="sd">    &gt;&gt;&gt; S2 = TensorType([Lorentz]*2, sym2)</span>
<span class="sd">    &gt;&gt;&gt; V = S2(&#39;V&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy.combinatorics</span> <span class="kn">import</span> <span class="n">Permutation</span>
    <span class="k">def</span> <span class="nf">tableau2bsgs</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># antisymmetric vector</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bsgs</span> <span class="o">=</span> <span class="n">get_symmetric_group_sgs</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">):</span>
                <span class="c"># symmetric vector</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="n">bsgs</span> <span class="o">=</span> <span class="n">get_symmetric_group_sgs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="n">bsgs</span> <span class="o">=</span> <span class="n">riemann_bsgs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">bsgs</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TensorSymmetry</span><span class="p">([[],</span> <span class="p">[</span><span class="n">Permutation</span><span class="p">(</span><span class="mi">1</span><span class="p">)]])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Permutation</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensorSymmetry</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">sgs</span> <span class="o">=</span> <span class="n">tableau2bsgs</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">basex</span><span class="p">,</span> <span class="n">sgsx</span> <span class="o">=</span> <span class="n">tableau2bsgs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">sgs</span> <span class="o">=</span> <span class="n">bsgs_direct_product</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">sgs</span><span class="p">,</span> <span class="n">basex</span><span class="p">,</span> <span class="n">sgsx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TensorSymmetry</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">sgs</span><span class="p">))</span>


<div class="viewcode-block" id="TensorType"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensorType">[docs]</a><span class="k">class</span> <span class="nc">TensorType</span><span class="p">(</span><span class="n">Basic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class of tensor types.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    index_types : list of ``TensorIndexType`` of the tensor indices</span>
<span class="sd">    symmetry : ``TensorSymmetry`` of the tensor</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``index_types``</span>
<span class="sd">    ``symmetry``</span>
<span class="sd">    ``types`` : list of ``TensorIndexType`` without repetitions</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    Define a symmetric tensor</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensorsymmetry, TensorType</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; sym2 = tensorsymmetry([1, 1])</span>
<span class="sd">    &gt;&gt;&gt; S2 = TensorType([Lorentz]*2, sym2)</span>
<span class="sd">    &gt;&gt;&gt; V = S2(&#39;V&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_commutative</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index_types</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">symmetry</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_types</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index_types</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_types</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;TensorType(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_types</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a TensorHead object or a list of TensorHead objects.</span>

<span class="sd">        ``s``  name or string of names</span>

<span class="sd">        ``comm``: commutation group number</span>
<span class="sd">        see ``_TensorManager.set_comm``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        Define symmetric tensors ``V``, ``W`` and ``G``, respectively</span>
<span class="sd">        commuting, anticommuting and with no commutation symmetry</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorsymmetry, TensorType, canon_bp</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a, b = tensor_indices(&#39;a,b&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; sym2 = tensorsymmetry([1]*2)</span>
<span class="sd">        &gt;&gt;&gt; S2 = TensorType([Lorentz]*2, sym2)</span>
<span class="sd">        &gt;&gt;&gt; V = S2(&#39;V&#39;)</span>
<span class="sd">        &gt;&gt;&gt; W = S2(&#39;W&#39;, 1)</span>
<span class="sd">        &gt;&gt;&gt; G = S2(&#39;G&#39;, 2)</span>
<span class="sd">        &gt;&gt;&gt; canon_bp(V(a, b)*V(-b, -a))</span>
<span class="sd">        V(L_0, L_1)*V(-L_0, -L_1)</span>
<span class="sd">        &gt;&gt;&gt; canon_bp(W(a, b)*W(-b, -a))</span>
<span class="sd">        0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;expecting a string&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TensorHead</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">TensorHead</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
</div>
<span class="k">def</span> <span class="nf">tensorhead</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function generating tensorhead(s).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    name : name or sequence of names (as in ``symbol``)</span>

<span class="sd">    typ :  index types</span>

<span class="sd">    sym :  same as ``*args`` in ``tensorsymmetry``</span>

<span class="sd">    comm : commutation group number</span>
<span class="sd">    see ``_TensorManager.set_comm``</span>


<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; a, b = tensor_indices(&#39;a,b&#39;, Lorentz)</span>
<span class="sd">    &gt;&gt;&gt; A = tensorhead(&#39;A&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">    &gt;&gt;&gt; A(a, -b)</span>
<span class="sd">    A(a, -b)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sym</span> <span class="o">=</span> <span class="n">tensorsymmetry</span><span class="p">(</span><span class="o">*</span><span class="n">sym</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">TensorType</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span>


<div class="viewcode-block" id="TensorHead"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensorHead">[docs]</a><span class="k">class</span> <span class="nc">TensorHead</span><span class="p">(</span><span class="n">Basic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tensor head of the tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    name : name of the tensor</span>

<span class="sd">    typ : list of TensorIndexType</span>

<span class="sd">    comm : commutation group number</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``name``</span>
<span class="sd">    ``index_types``</span>
<span class="sd">    ``rank``</span>
<span class="sd">    ``types``  :  equal to ``typ.types``</span>
<span class="sd">    ``symmetry`` : equal to ``typ.symmetry``</span>
<span class="sd">    ``comm`` : commutation group</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    A ``TensorHead`` belongs to a commutation group, defined by a</span>
<span class="sd">    symbol on number ``comm`` (see ``_TensorManager.set_comm``);</span>
<span class="sd">    tensors in a commutation group have the same commutation properties;</span>
<span class="sd">    by default ``comm`` is ``0``, the group of the commuting tensors.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensorsymmetry, TensorType</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; sym2 = tensorsymmetry([1]*2)</span>
<span class="sd">    &gt;&gt;&gt; S2 = TensorType([Lorentz]*2, sym2)</span>
<span class="sd">    &gt;&gt;&gt; A = S2(&#39;A&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_commutative</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">index_types</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">types</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_symmetry</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">symmetry</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_comm</span> <span class="o">=</span> <span class="n">TensorManager</span><span class="o">.</span><span class="n">comm_symbols2i</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">[:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">typ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index_types</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_types</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">index_types</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hashable_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

<div class="viewcode-block" id="TensorHead.commutes_with"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensorHead.commutes_with">[docs]</a>    <span class="k">def</span> <span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns 0 (1) if self and other (anti)commute.</span>

<span class="sd">        Returns None if self and other do not (anti)commute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">TensorManager</span><span class="o">.</span><span class="n">get_comm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

</div>
    <span class="k">def</span> <span class="nf">_pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_types</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tensor with indices.</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a, b = tensor_indices(&#39;a,b&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A = tensorhead(&#39;A&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">        &gt;&gt;&gt; t = A(a, -b)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_tensortype</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;wrong index type&#39;</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="n">free</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span>  <span class="n">TensMul</span><span class="o">.</span><span class="n">from_indices</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">free</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dum</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">dum</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="TensExpr"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensExpr">[docs]</a><span class="k">class</span> <span class="nc">TensExpr</span><span class="p">(</span><span class="n">Basic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for tensor expressions</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    A tensor expression is an expression formed by tensors;</span>
<span class="sd">    currently the sums of tensors are distributed.</span>

<span class="sd">    A ``TensExpr`` can be a ``TensAdd`` or a ``TensMul``.</span>

<span class="sd">    ``TensAdd`` objects are put in canonical form using the Butler-Portugal</span>
<span class="sd">    algorithm for canonicalization under monoterm symmetries.</span>

<span class="sd">    ``TensMul`` objects are formed by products of component tensors,</span>
<span class="sd">    and include a coefficient, which is a SymPy expression.</span>


<span class="sd">    In the internal representation contracted indices are represented</span>
<span class="sd">    by ``(ipos1, ipos2, icomp1, icomp2)``, where ``icomp1`` is the position</span>
<span class="sd">    of the component tensor with contravariant index, ``ipos1`` is the</span>
<span class="sd">    slot which the index occupies in that component tensor.</span>

<span class="sd">    Contracted indices are therefore nameless in the internal representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_op_priority</span> <span class="o">=</span> <span class="mf">11.0</span>
    <span class="n">is_commutative</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">*</span><span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span>

    <span class="k">def</span> <span class="nf">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">*</span><span class="n">other</span>

    <span class="k">def</span> <span class="nf">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__rpow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="n">__truediv__</span> <span class="o">=</span> <span class="n">__div__</span>
    <span class="n">__rtruediv__</span> <span class="o">=</span> <span class="n">__rdiv__</span>

</div>
<span class="k">def</span> <span class="nf">_tensAdd_collect_terms</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    collect TensMul terms differing at most by their coefficient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pprev</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">prev_coeff</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">_coeff</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="c"># if x and prev have the same tensor, update the coeff of prev</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">_components</span> <span class="o">==</span> <span class="n">prev</span><span class="o">.</span><span class="n">_components</span> \
                <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">_free</span> <span class="o">==</span> <span class="n">prev</span><span class="o">.</span><span class="n">_free</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">_dum</span> <span class="o">==</span> <span class="n">prev</span><span class="o">.</span><span class="n">_dum</span><span class="p">:</span>
            <span class="n">prev_coeff</span> <span class="o">=</span> <span class="n">prev_coeff</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">_coeff</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># x and prev are different; if not changed, prev has not</span>
            <span class="c"># been updated; store it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># get a tensor from prev with coeff=prev_coeff and store it</span>
                <span class="k">if</span> <span class="n">prev_coeff</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">prev_coeff</span><span class="p">,</span> <span class="n">prev</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span>
                        <span class="n">prev</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="n">prev</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="c"># move x to prev</span>
            <span class="n">op</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">pprev</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">,</span> <span class="n">x</span>
            <span class="n">pprev_coeff</span><span class="p">,</span> <span class="n">prev_coeff</span> <span class="o">=</span> <span class="n">prev_coeff</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">_coeff</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># if the case op=0 prev was not stored; store it now</span>
    <span class="c"># in the case op=1 x was not stored; store it now (as prev)</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prev_coeff</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">prev_coeff</span><span class="p">,</span> <span class="n">prev</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">prev</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="n">prev</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">_tensAdd_flatten</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    flatten TensAdd, coerce terms which are not tensors to tensors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">args1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TensAdd</span><span class="p">):</span>
                    <span class="n">args1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">args1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args1</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">_coeff</span><span class="p">]</span>
        <span class="n">args2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">)]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">args2</span><span class="p">),</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">t1</span><span class="p">]</span> <span class="o">+</span> <span class="n">args1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TensAdd</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">_coeff</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">_tensAdd_check</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check that all addends have the same free indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indices0</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_free</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">list_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">_free</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">indices0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_indices</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;all tensors must have the same indices&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="TensAdd"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensAdd">[docs]</a><span class="k">class</span> <span class="nc">TensAdd</span><span class="p">(</span><span class="n">TensExpr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sum of tensors</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    free_args : list of the free indices</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``args`` : tuple of addends</span>
<span class="sd">    ``rank`` : rank of the tensor</span>
<span class="sd">    ``free_args`` : list of the free indices in sorted order</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    Sum of more than one tensor are put automatically in canonical form.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensorhead, tensor_indices</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; a, b = tensor_indices(&#39;a,b&#39;, Lorentz)</span>
<span class="sd">    &gt;&gt;&gt; p, q = tensorhead(&#39;p,q&#39;, [Lorentz], [[1]])</span>
<span class="sd">    &gt;&gt;&gt; t = p(a) + q(a); t</span>
<span class="sd">    p(a) + q(a)</span>
<span class="sd">    &gt;&gt;&gt; t(b)</span>
<span class="sd">    p(b) + q(b)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sympify</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">_tensAdd_flatten</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">Zero</span>

        <span class="n">_tensAdd_check</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TensMul</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">canon_bp</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">Zero</span>

        <span class="c"># collect canonicalized terms</span>
        <span class="n">args</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">_dum</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_tensAdd_collect_terms</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">Zero</span>
        <span class="c"># it there is only a component tensor return it</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">free_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">free_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns tensor with ordered free indices replaced by ``indices``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        indices</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy import Symbol</span>
<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; D = Symbol(&#39;D&#39;)</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dim=D, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i0,i1,i2,i3,i4 = tensor_indices(&#39;i0:5&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; p, q = tensorhead(&#39;p,q&#39;, [Lorentz], [[1]])</span>
<span class="sd">        &gt;&gt;&gt; g = Lorentz.metric</span>
<span class="sd">        &gt;&gt;&gt; t = p(i0)*p(i1) + g(i0,i1)*q(i2)*q(-i2)</span>
<span class="sd">        &gt;&gt;&gt; t(i0,i2)</span>
<span class="sd">        metric(i0, i2)*q(L_0)*q(-L_0) + p(i0)*p(i2)</span>
<span class="sd">        &gt;&gt;&gt; t(i0,i1) - t(i1,i0)</span>
<span class="sd">        0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">free_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_args</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_tensortype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_tensortype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">free_args</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;incompatible types&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="o">==</span> <span class="n">free_args</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">index_tuples</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">free_args</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">fun_eval</span><span class="p">(</span><span class="o">*</span><span class="n">index_tuples</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="TensAdd.canon_bp"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensAdd.canon_bp">[docs]</a>    <span class="k">def</span> <span class="nf">canon_bp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        canonicalize using the Butler-Portugal algorithm for canonicalization</span>
<span class="sd">        under monoterm symmetries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">canon_bp</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TensMul</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">other</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TensMul</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">-</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">other</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;cannot divide by a tensor&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="o">/</span><span class="n">other</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;cannot divide by a tensor&#39;</span><span class="p">)</span>

    <span class="n">__truediv__</span> <span class="o">=</span> <span class="n">__div__</span>
    <span class="n">__truerdiv__</span> <span class="o">=</span> <span class="n">__rdiv__</span>

    <span class="k">def</span> <span class="nf">_hashable_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TensAdd</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__hash__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contract_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">contract_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">canon_bp</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<div class="viewcode-block" id="TensAdd.contract_metric"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensAdd.contract_metric">[docs]</a>    <span class="k">def</span> <span class="nf">contract_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">contract_all</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise or lower indices with the metric ``g``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        g :  metric</span>

<span class="sd">        contract_all : if True, eliminate all ``g`` which are contracted</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>

<span class="sd">        see the ``TensorIndexType`` docstring for the contraction conventions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">contract_metric</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">contract_all</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">canon_bp</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="TensAdd.fun_eval"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensAdd.fun_eval">[docs]</a>    <span class="k">def</span> <span class="nf">fun_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">index_tuples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tensor with free indices substituted according to ``index_tuples``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        index_types : list of tuples ``(old_index, new_index)``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i, j, k, l = tensor_indices(&#39;i,j,k,l&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A, B = tensorhead(&#39;A,B&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">        &gt;&gt;&gt; t = A(i, k)*B(-k, -j) + A(i, -j)</span>
<span class="sd">        &gt;&gt;&gt; t.fun_eval((i, k),(-j, l))</span>
<span class="sd">        A(k, L_0)*B(l, -L_0) + A(k, l)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="n">args1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">fun_eval</span><span class="p">(</span><span class="o">*</span><span class="n">index_tuples</span><span class="p">)</span>
            <span class="n">args1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">args1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TensAdd.substitute_indices"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensAdd.substitute_indices">[docs]</a>    <span class="k">def</span> <span class="nf">substitute_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">index_tuples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tensor with free indices substituted according to ``index_tuples``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        index_types : list of tuples ``(old_index, new_index)``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i, j, k, l = tensor_indices(&#39;i,j,k,l&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A, B = tensorhead(&#39;A,B&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">        &gt;&gt;&gt; t = A(i, k)*B(-k, -j); t</span>
<span class="sd">        A(i, L_0)*B(-L_0, -j)</span>
<span class="sd">        &gt;&gt;&gt; t.substitute_indices((i,j), (j, k))</span>
<span class="sd">        A(j, L_0)*B(-L_0, -k)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="n">args1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">substitute_indices</span><span class="p">(</span><span class="o">*</span><span class="n">index_tuples</span><span class="p">)</span>
            <span class="n">args1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">args1</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">a</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+ -&#39;</span><span class="p">,</span> <span class="s">&#39;- &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="TensMul"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul">[docs]</a><span class="k">class</span> <span class="nc">TensMul</span><span class="p">(</span><span class="n">TensExpr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Product of tensors</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    coeff : SymPy coefficient of the tensor</span>
<span class="sd">    args</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    ``_components`` : list of ``TensorHead`` of the component tensors</span>
<span class="sd">    ``types`` : list of nonrepeated ``TensorIndexType``</span>
<span class="sd">    ``free`` : list of ``(ind, ipos, icomp)``, see Notes</span>
<span class="sd">    ``dum`` : list of ``(ipos1, ipos2, icomp1, icomp2)``, see Notes</span>
<span class="sd">    ``ext_rank`` : rank of the tensor counting the dummy indices</span>
<span class="sd">    ``rank`` : rank of the tensor</span>
<span class="sd">    ``coeff`` : SymPy coefficient of the tensor</span>
<span class="sd">    ``free_args`` : list of the free indices in sorted order</span>
<span class="sd">    ``is_canon_bp`` : ``True`` if the tensor in in canonical form</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    ``args[0]``   list of ``TensorHead`` of the component tensors.</span>

<span class="sd">    ``args[1]``   list of ``(ind, ipos, icomp)``</span>
<span class="sd">    where ``ind`` is a free index, ``ipos`` is the slot position</span>
<span class="sd">    of ``ind`` in the ``icomp``-th component tensor.</span>

<span class="sd">    ``args[2]`` list of tuples representing dummy indices.</span>
<span class="sd">    ``(ipos1, ipos2, icomp1, icomp2)`` indicates that the contravariant</span>
<span class="sd">    dummy index is the ``ipos1``-th slot position in the ``icomp1``-th</span>
<span class="sd">    component tensor; the corresponding covariant index is</span>
<span class="sd">    in the ``ipos2`` slot position in the ``icomp2``-th component tensor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Basic</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">_types</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_free</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_dum</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_ext_rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_free</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">=</span> <span class="n">coeff</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_is_canon_bp</span> <span class="o">=</span> <span class="n">kw_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_canon_bp&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">free_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">[:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">[:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="n">other</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_hashable_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canon_bp</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">_components</span><span class="p">),</span> \
                <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">_free</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">_dum</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TensMul</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__hash__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TensMul.from_indices"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.from_indices">[docs]</a>    <span class="k">def</span> <span class="nf">from_indices</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert ``indices`` into ``free``, ``dum`` for single component tensor</span>

<span class="sd">        ``free``     list of tuples ``(index, pos, 0)``,</span>
<span class="sd">                     where ``pos`` is the position of index in</span>
<span class="sd">                     the list of indices formed by the component tensors</span>

<span class="sd">        ``dum``      list of tuples ``(pos_contr, pos_cov, 0, 0)``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, TensMul</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; m0, m1, m2, m3 = tensor_indices(&#39;m0,m1,m2,m3&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; TensMul.from_indices(m0, m1, -m1, m3)</span>
<span class="sd">        ([(m0, 0, 0), (m3, 3, 0)], [(1, 2, 0, 0)])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="p">[]</span>

        <span class="c"># find the positions of the free indices and of the dummy indices</span>
        <span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">index_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">_name</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">_tensortype</span>
            <span class="n">contr</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">_is_up</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">index_dict</span><span class="p">:</span>
                <span class="c"># found a pair of dummy indices</span>
                <span class="n">is_contr</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">index_dict</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">)]</span>
                <span class="c"># check consistency and update free</span>
                <span class="k">if</span> <span class="n">is_contr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">contr</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;two equal contravariant indices in slots </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">free</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">contr</span><span class="p">:</span>
                        <span class="n">free</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;two equal covariant indices in slots </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">contr</span><span class="p">:</span>
                    <span class="n">dum</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dum</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_dict</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">_is_up</span><span class="p">,</span> <span class="n">i</span>

        <span class="n">free</span> <span class="o">=</span> <span class="p">[(</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">free</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">free</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">free</span><span class="p">,</span> <span class="n">dum</span>
</div>
<div class="viewcode-block" id="TensMul.get_indices"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.get_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of indices of the tensor</span>

<span class="sd">        The indices are listed in the order in which they appear in the</span>
<span class="sd">        component tensors.</span>
<span class="sd">        The dummy indices are given a name which does not collide with</span>
<span class="sd">        the names of the free indices.</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; m0, m1, m2 = tensor_indices(&#39;m0,m1,m2&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; g = Lorentz.metric</span>
<span class="sd">        &gt;&gt;&gt; p, q = tensorhead(&#39;p,q&#39;, [Lorentz], [[1]])</span>
<span class="sd">        &gt;&gt;&gt; t = p(m1)*g(m0,m2)</span>
<span class="sd">        &gt;&gt;&gt; t.get_indices()</span>
<span class="sd">        [m1, m0, m2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ext_rank</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vpos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">vpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span>
        <span class="n">cdt</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c"># if the free indices have names with dummy_fmt, start with an</span>
        <span class="c"># index higher than those for the dummy indices</span>
        <span class="c"># to avoid name collisions</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indx</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">indx</span><span class="o">.</span><span class="n">_tensortype</span><span class="o">.</span><span class="n">_dummy_fmt</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">cdt</span><span class="p">[</span><span class="n">indx</span><span class="o">.</span><span class="n">_tensortype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cdt</span><span class="p">[</span><span class="n">indx</span><span class="o">.</span><span class="n">_tensortype</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">indx</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="n">cpos</span><span class="p">]</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx</span>
        <span class="k">for</span> <span class="n">ipos1</span><span class="p">,</span> <span class="n">ipos2</span><span class="p">,</span> <span class="n">cpos1</span><span class="p">,</span> <span class="n">cpos2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">:</span>
            <span class="n">start1</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="n">cpos1</span><span class="p">]</span>
            <span class="n">start2</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="n">cpos2</span><span class="p">]</span>
            <span class="n">typ1</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">cpos1</span><span class="p">]</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="n">ipos1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">typ1</span> <span class="o">==</span> <span class="n">components</span><span class="p">[</span><span class="n">cpos2</span><span class="p">]</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="n">ipos2</span><span class="p">]</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">typ1</span><span class="o">.</span><span class="n">dummy_fmt</span>
            <span class="n">nd</span> <span class="o">=</span> <span class="n">cdt</span><span class="p">[</span><span class="n">typ1</span><span class="p">]</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">start1</span> <span class="o">+</span> <span class="n">ipos1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TensorIndex</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="n">nd</span><span class="p">,</span> <span class="n">typ1</span><span class="p">)</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">start2</span> <span class="o">+</span> <span class="n">ipos2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TensorIndex</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="n">nd</span><span class="p">,</span> <span class="n">typ1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">cdt</span><span class="p">[</span><span class="n">typ1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">indices</span>
</div>
<div class="viewcode-block" id="TensMul.split"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of tensors, whose product is ``self``</span>

<span class="sd">        Dummy indices contracted among different tensor components</span>
<span class="sd">        become free indices with the same name as the one used to</span>
<span class="sd">        represent the dummy indices.</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a, b, c, d = tensor_indices(&#39;a,b,c,d&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A, B = tensorhead(&#39;A,B&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">        &gt;&gt;&gt; t = A(a,b)*B(-b,c)</span>
<span class="sd">        &gt;&gt;&gt; t</span>
<span class="sd">        A(a, L_0)*B(-L_0, c)</span>
<span class="sd">        &gt;&gt;&gt; t.split()</span>
<span class="sd">        [A(a, L_0), B(-L_0, c)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">TensMul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_dum</span><span class="p">,</span> <span class="n">is_canon_bp</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_is_canon_bp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="TensMul.canon_args"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.canon_args">[docs]</a>    <span class="k">def</span> <span class="nf">canon_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``(g, dummies, msym, v)``, the entries of ``canonicalize``</span>

<span class="sd">        see ``canonicalize`` in ``tensor_can.py``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># to be called after sorted_components</span>
        <span class="kn">from</span> <span class="nn">sympy.combinatorics.permutations</span> <span class="kn">import</span> <span class="n">_af_new</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">))</span>
        <span class="n">types</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_rank</span>
        <span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">n</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vpos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">vpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span>
        <span class="c"># ordered indices: first the free indices, ordered by types</span>
        <span class="c"># then the dummy indices, ordered by types and contravariant before</span>
        <span class="c"># covariant</span>
        <span class="c"># g[position in tensor] = position in ordered indices</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="n">cpos</span><span class="p">]</span> <span class="o">+</span> <span class="n">ipos</span>
            <span class="n">g</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">)</span>
        <span class="n">dummies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ipos1</span><span class="p">,</span> <span class="n">ipos2</span><span class="p">,</span> <span class="n">cpos1</span><span class="p">,</span> <span class="n">cpos2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">:</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="n">cpos1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ipos1</span>
            <span class="n">pos2</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="n">cpos2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ipos2</span>
            <span class="n">g</span><span class="p">[</span><span class="n">pos1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">g</span><span class="p">[</span><span class="n">pos2</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">cpos1</span><span class="p">]</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="n">ipos1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
                    <span class="n">dummies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">typ</span>
                <span class="n">msym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">metric_antisym</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">dummies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">numtyp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">prev</span><span class="p">:</span>
                <span class="n">numtyp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">t</span>
                <span class="n">numtyp</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prev</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">numtyp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">_comm</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h</span><span class="o">.</span><span class="n">_comm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">comm</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">_comm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comm</span> <span class="o">=</span> <span class="n">TensorManager</span><span class="o">.</span><span class="n">get_comm</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_comm</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">h</span><span class="o">.</span><span class="n">_symmetry</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">_symmetry</span><span class="o">.</span><span class="n">generators</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">comm</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_af_new</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">dummies</span><span class="p">,</span> <span class="n">msym</span><span class="p">,</span> <span class="n">v</span>
</div>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">-</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiply two tensors using Einstein summation convention.</span>

<span class="sd">        If the two tensors have an index in common, one contravariant</span>
<span class="sd">        and the other covariant, in their product the indices are summed</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; m0, m1, m2 = tensor_indices(&#39;m0,m1,m2&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; g = Lorentz.metric</span>
<span class="sd">        &gt;&gt;&gt; p, q = tensorhead(&#39;p,q&#39;, [Lorentz], [[1]])</span>
<span class="sd">        &gt;&gt;&gt; t1 = p(m0)</span>
<span class="sd">        &gt;&gt;&gt; t2 = q(-m0)</span>
<span class="sd">        &gt;&gt;&gt; t1*t2</span>
<span class="sd">        p(L_0)*q(-L_0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="o">*</span><span class="n">other</span>
            <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">,</span> <span class="n">is_canon_bp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_canon_bp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TensAdd</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>

        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_components</span>
        <span class="c"># find out which free indices of self and other are contracted</span>
        <span class="n">free_dict1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">cpos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">])</span>
        <span class="n">free_dict2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">cpos</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_free</span><span class="p">])</span>

        <span class="n">free_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">free_dict1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">free_dict2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c"># find the new `free` and `dum`</span>
        <span class="n">nc1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">)</span>
        <span class="n">dum2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">nc1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">+</span> <span class="n">nc1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_dum</span><span class="p">]</span>
        <span class="n">free1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span> <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_names</span><span class="p">]</span>
        <span class="n">free2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">nc1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_free</span> <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_names</span><span class="p">]</span>
        <span class="n">free</span> <span class="o">=</span> <span class="n">free1</span> <span class="o">+</span> <span class="n">free2</span>
        <span class="n">dum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span> <span class="o">+</span> <span class="n">dum2</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">free_names</span><span class="p">:</span>
            <span class="n">ipos1</span><span class="p">,</span> <span class="n">cpos1</span><span class="p">,</span> <span class="n">ind1</span> <span class="o">=</span> <span class="n">free_dict1</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">ipos2</span><span class="p">,</span> <span class="n">cpos2</span><span class="p">,</span> <span class="n">ind2</span> <span class="o">=</span> <span class="n">free_dict2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">cpos2</span> <span class="o">+=</span> <span class="n">nc1</span>
            <span class="k">if</span> <span class="n">ind1</span><span class="o">.</span><span class="n">_is_up</span> <span class="o">==</span> <span class="n">ind2</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;wrong index contruction </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ind1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind1</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
                <span class="n">new_dummy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipos1</span><span class="p">,</span> <span class="n">ipos2</span><span class="p">,</span> <span class="n">cpos1</span><span class="p">,</span> <span class="n">cpos2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dummy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipos2</span><span class="p">,</span> <span class="n">ipos1</span><span class="p">,</span> <span class="n">cpos2</span><span class="p">,</span> <span class="n">cpos1</span><span class="p">)</span>
            <span class="n">dum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_dummy</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">_coeff</span>
        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">dum</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">other</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span>
        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;cannot divide by a tensor&#39;</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="o">/</span><span class="n">other</span>
        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">,</span> <span class="n">is_canon_bp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_canon_bp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;cannot divide by a tensor&#39;</span><span class="p">)</span>

    <span class="n">__truediv__</span> <span class="o">=</span> <span class="n">__div__</span>
    <span class="n">__truerdiv__</span> <span class="o">=</span> <span class="n">__rdiv__</span>

<div class="viewcode-block" id="TensMul.sorted_components"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.sorted_components">[docs]</a>    <span class="k">def</span> <span class="nf">sorted_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tensor with sorted components</span>

<span class="sd">        The sorting is done taking into account the commutation group</span>
<span class="sd">        of the component tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sympy.combinatorics.permutations</span> <span class="kn">import</span> <span class="n">_af_invert</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">)))</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_types</span><span class="p">,</span> <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span> <span class="o">&gt;</span> \
                        <span class="p">(</span><span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_types</span><span class="p">,</span> <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_name</span><span class="p">):</span>
                    <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">cv</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">sign</span>

        <span class="c"># perm_inv[new_pos] = old_pos</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cv</span><span class="p">]</span>
        <span class="n">perm_inv</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cv</span><span class="p">]</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">_af_invert</span><span class="p">(</span><span class="n">perm_inv</span><span class="p">)</span>
        <span class="n">free</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">perm</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">]</span>
        <span class="n">free</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">dum</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">perm</span><span class="p">[</span><span class="n">c1</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">c2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">]</span>
        <span class="n">dum</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">components</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span> <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">dum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span>
</div>
<div class="viewcode-block" id="TensMul.perm2tensor"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.perm2tensor">[docs]</a>    <span class="k">def</span> <span class="nf">perm2tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">canon_bp</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the tensor corresponding to the permutation ``g``</span>

<span class="sd">        ``g``  permutation corrisponding to the tensor in the representation</span>
<span class="sd">        used in canonicalization</span>

<span class="sd">        ``canon_bp``   if True, then ``g`` is the permutation</span>
<span class="sd">        corresponding to the canonical form of the tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_right</span>
        <span class="n">vpos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">vpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span>
        <span class="n">sorted_free</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">]</span>
        <span class="n">sorted_free</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">nfree</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_free</span><span class="p">)</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_rank</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">rank</span>
        <span class="n">dum</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">rank</span> <span class="o">-</span> <span class="n">nfree</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">free</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">icomp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vpos</span><span class="p">:</span>
                <span class="n">icomp</span> <span class="o">+=</span> <span class="n">vpos</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">pos0</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">ipos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">pos0</span>
            <span class="n">gi</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gi</span> <span class="o">&lt;</span> <span class="n">nfree</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">sorted_free</span><span class="p">[</span><span class="n">gi</span><span class="p">]</span>
                <span class="n">free</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">icomp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">gi</span> <span class="o">-</span> <span class="n">nfree</span>
                <span class="n">idum</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cov</span><span class="p">:</span>
                    <span class="n">dum</span><span class="p">[</span><span class="n">idum</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipos</span>
                    <span class="n">dum</span><span class="p">[</span><span class="n">idum</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">icomp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dum</span><span class="p">[</span><span class="n">idum</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipos</span>
                    <span class="n">dum</span><span class="p">[</span><span class="n">idum</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">icomp</span>
        <span class="n">dum</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dum</span><span class="p">]</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">is_canon_bp</span><span class="o">=</span><span class="n">canon_bp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="TensMul.canon_bp"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.canon_bp">[docs]</a>    <span class="k">def</span> <span class="nf">canon_bp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        canonicalize using the Butler-Portugal algorithm for canonicalization</span>
<span class="sd">        under monoterm symmetries.</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; m0, m1, m2 = tensor_indices(&#39;m0,m1,m2&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A = tensorhead(&#39;A&#39;, [Lorentz]*2, [[2]])</span>
<span class="sd">        &gt;&gt;&gt; t = A(m0,-m1)*A(m1,-m0)</span>
<span class="sd">        &gt;&gt;&gt; t.canon_bp()</span>
<span class="sd">        -A(L_0, L_1)*A(-L_0, -L_1)</span>
<span class="sd">        &gt;&gt;&gt; t = A(m0,-m1)*A(m1,-m2)*A(m2,-m0)</span>
<span class="sd">        &gt;&gt;&gt; t.canon_bp()</span>
<span class="sd">        0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sympy.combinatorics.tensor_can</span> <span class="kn">import</span> <span class="n">canonicalize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_canon_bp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_components</span><span class="p">()</span>
        <span class="n">g</span><span class="p">,</span> <span class="n">dummies</span><span class="p">,</span> <span class="n">msym</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">canon_args</span><span class="p">()</span>
        <span class="n">can</span> <span class="o">=</span> <span class="n">canonicalize</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">dummies</span><span class="p">,</span> <span class="n">msym</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">can</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">Zero</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">perm2tensor</span><span class="p">(</span><span class="n">can</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">,</span> <span class="n">contract_all</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        helper method for ``contract_metric`` and ``contract_delta``</span>

<span class="sd">        ``g`` metric to be contracted</span>

<span class="sd">        ``antisym``:</span>
<span class="sd">        False  symmetric metric</span>
<span class="sd">        True   antisymmetric metric</span>
<span class="sd">        None   delta</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">free_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tg</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">:</span>
                <span class="n">tg_free</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tg</span><span class="o">.</span><span class="n">_free</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tg_free</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">_contract_g_with_itself</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">tg_free</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">contract_all</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">_contract</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">t</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">indx</span> <span class="ow">in</span> <span class="n">free_indices</span> <span class="k">for</span> <span class="n">indx</span> <span class="ow">in</span> <span class="n">tg_free</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># all metric tensors have only free indices, there is no contraction</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c"># tg has one or two indices contracted with other tensors</span>
        <span class="c"># i position of tg in a</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="n">tg_free</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">_free</span>
        <span class="k">if</span> <span class="n">antisym</span><span class="p">:</span>
            <span class="c"># order by slot position</span>
            <span class="n">tg_free</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tg_free</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">free_indices</span> <span class="ow">or</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">free_indices</span><span class="p">:</span>
            <span class="c"># tg has one free index</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_contract_g_with_free_index</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">free_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">tg_free</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># tg has two indices contracted with other tensors</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_contract_g_without_free_index</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">free_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">tg_free</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">antisym</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contract_all</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">_contract</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">contract_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contract</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span>

<div class="viewcode-block" id="TensMul.contract_metric"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.contract_metric">[docs]</a>    <span class="k">def</span> <span class="nf">contract_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">contract_all</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise or lower indices with the metric ``g``</span>

<span class="sd">        ``g``  metric</span>

<span class="sd">        ``contract_all`` if True, eliminate all ``g`` which are contracted</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>

<span class="sd">        see the ``TensorIndexType`` docstring for the contraction conventions</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; m0, m1, m2 = tensor_indices(&#39;m0,m1,m2&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; g = Lorentz.metric</span>
<span class="sd">        &gt;&gt;&gt; p, q = tensorhead(&#39;p,q&#39;, [Lorentz], [[1]])</span>
<span class="sd">        &gt;&gt;&gt; t = p(m0)*q(m1)*g(-m0, -m1)</span>
<span class="sd">        &gt;&gt;&gt; t.canon_bp()</span>
<span class="sd">        metric(L_0, L_1)*p(-L_0)*q(-L_1)</span>
<span class="sd">        &gt;&gt;&gt; t.contract_metric(g).canon_bp()</span>
<span class="sd">        p(L_0)*q(-L_0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contract</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metric_antisym</span><span class="p">,</span> <span class="n">contract_all</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="TensMul.substitute_indices"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.substitute_indices">[docs]</a>    <span class="k">def</span> <span class="nf">substitute_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">index_tuples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tensor with free indices substituted according to ``index_tuples``</span>

<span class="sd">        ``index_types`` list of tuples ``(old_index, new_index)``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i, j, k, l = tensor_indices(&#39;i,j,k,l&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A, B = tensorhead(&#39;A,B&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">        &gt;&gt;&gt; t = A(i, k)*B(-k, -j); t</span>
<span class="sd">        A(i, L_0)*B(-L_0, -j)</span>
<span class="sd">        &gt;&gt;&gt; t.substitute_indices((i,j), (j, k))</span>
<span class="sd">        A(j, L_0)*B(-L_0, -k)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span>
        <span class="n">free1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span> <span class="ow">in</span> <span class="n">free</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">index_tuples</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">_tensortype</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">_tensortype</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">_is_up</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
                        <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">free1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TensMul.fun_eval"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.TensMul.fun_eval">[docs]</a>    <span class="k">def</span> <span class="nf">fun_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">index_tuples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tensor with free indices substituted according to ``index_tuples``</span>

<span class="sd">        ``index_types`` list of tuples ``(old_index, new_index)``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i, j, k, l = tensor_indices(&#39;i,j,k,l&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; A, B = tensorhead(&#39;A,B&#39;, [Lorentz]*2, [[1]*2])</span>
<span class="sd">        &gt;&gt;&gt; t = A(i, k)*B(-k, -j); t</span>
<span class="sd">        A(i, L_0)*B(-L_0, -j)</span>
<span class="sd">        &gt;&gt;&gt; t.fun_eval((i, k),(-j, l))</span>
<span class="sd">        A(k, L_0)*B(-L_0, l)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span>
        <span class="n">free1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span> <span class="ow">in</span> <span class="n">free</span><span class="p">:</span>
            <span class="c"># search j in index_tuples</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">index_tuples</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">cpos</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">free1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns tensor with ordered free indices replaced by ``indices``</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy import Symbol</span>
<span class="sd">        &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead</span>
<span class="sd">        &gt;&gt;&gt; D = Symbol(&#39;D&#39;)</span>
<span class="sd">        &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dim=D, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">        &gt;&gt;&gt; i0,i1,i2,i3,i4 = tensor_indices(&#39;i0:5&#39;, Lorentz)</span>
<span class="sd">        &gt;&gt;&gt; g = Lorentz.metric</span>
<span class="sd">        &gt;&gt;&gt; p, q = tensorhead(&#39;p,q&#39;, [Lorentz], [[1]])</span>
<span class="sd">        &gt;&gt;&gt; t = p(i0)*q(i1)*q(-i1)</span>
<span class="sd">        &gt;&gt;&gt; t(i1)</span>
<span class="sd">        p(i1)*q(L_0)*q(-L_0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">free_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_args</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_tensortype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_tensortype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">free_args</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;incompatible types&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="o">==</span> <span class="n">free_args</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun_eval</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="n">free_args</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">t</span>


    <span class="k">def</span> <span class="nf">_pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices</span><span class="p">()]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">_rank</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span><span class="o">.</span> <span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span> <span class="o">==</span> <span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">res</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="o">.</span><span class="n">is_Atom</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">*</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)*</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="canon_bp"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.canon_bp">[docs]</a><span class="k">def</span> <span class="nf">canon_bp</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Butler-Portugal canonicalization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TensExpr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">canon_bp</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">p</span>
</div>
<div class="viewcode-block" id="tensor_mul"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.tensor_mul">[docs]</a><span class="k">def</span> <span class="nf">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    product of tensors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">tx</span>
    <span class="k">return</span> <span class="n">t</span>


</div>
<div class="viewcode-block" id="riemann_cyclic_replace"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.riemann_cyclic_replace">[docs]</a><span class="k">def</span> <span class="nf">riemann_cyclic_replace</span><span class="p">(</span><span class="n">t_r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    replace Riemann tensor with an equivalent expression</span>

<span class="sd">    ``R(m,n,p,q) -&gt; 2/3*R(m,n,p,q) - 1/3*R(m,q,n,p) + 1/3*R(m,p,n,q)``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">free</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">t_r</span><span class="o">.</span><span class="n">_free</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">free</span><span class="p">]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">t_r</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">t_r</span><span class="o">.</span><span class="n">substitute_indices</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">m</span><span class="p">),(</span><span class="n">n</span><span class="p">,</span><span class="n">q</span><span class="p">),(</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">),(</span><span class="n">q</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">t_r</span><span class="o">.</span><span class="n">substitute_indices</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">m</span><span class="p">),(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">),(</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">),(</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>
    <span class="k">return</span> <span class="n">t3</span>
</div>
<div class="viewcode-block" id="riemann_cyclic"><a class="viewcode-back" href="../../../modules/tensor/tensor.html#sympy.tensor.tensor.riemann_cyclic">[docs]</a><span class="k">def</span> <span class="nf">riemann_cyclic</span><span class="p">(</span><span class="n">t2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    replace each Riemann tensor with an equivalent expression</span>
<span class="sd">    satisfying the cyclic identity.</span>

<span class="sd">    This trick is discussed in the reference guide to Cadabra.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.tensor.tensor import TensorIndexType, tensor_indices, tensorhead, riemann_cyclic</span>
<span class="sd">    &gt;&gt;&gt; Lorentz = TensorIndexType(&#39;Lorentz&#39;, dummy_fmt=&#39;L&#39;)</span>
<span class="sd">    &gt;&gt;&gt; i, j, k, l = tensor_indices(&#39;i,j,k,l&#39;, Lorentz)</span>
<span class="sd">    &gt;&gt;&gt; R = tensorhead(&#39;R&#39;, [Lorentz]*4, [[2, 2]])</span>
<span class="sd">    &gt;&gt;&gt; t = R(i,j,k,l)*(R(-i,-j,-k,-l) - 2*R(-i,-k,-j,-l))</span>
<span class="sd">    &gt;&gt;&gt; riemann_cyclic(t)</span>
<span class="sd">    0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">TensMul</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">t2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">args</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">riemann_cyclic_replace</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">a1</span><span class="p">]</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="p">[</span><span class="n">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a2</span><span class="p">]</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">TensAdd</span><span class="p">(</span><span class="o">*</span><span class="n">a3</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">t3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">canon_bp</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">tensorlist_contract_metric</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    contract `tg` with a tensor in the list `a = t.split()`</span>
<span class="sd">    Only for symmetric metric.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tg</span><span class="o">.</span><span class="n">_free</span><span class="p">]</span>
    <span class="n">mind1</span> <span class="o">=</span> <span class="o">-</span><span class="n">ind1</span>
    <span class="n">mind2</span> <span class="o">=</span> <span class="o">-</span><span class="n">ind2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">_free</span><span class="p">)):</span>
            <span class="n">indx</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">_free</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">mind1</span> <span class="ow">or</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">mind2</span><span class="p">:</span>
                <span class="n">ind3</span> <span class="o">=</span> <span class="n">ind2</span> <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">mind1</span> <span class="k">else</span> <span class="n">ind1</span>
                <span class="n">free1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">_free</span><span class="p">[:]</span>
                <span class="n">free1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind3</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">free1</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>
                <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2</span>
                <span class="k">return</span> <span class="n">a</span>
    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">_contract_g_with_itself</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">tg_free</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper function for _contract</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">index_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">t11</span> <span class="o">=</span> <span class="n">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">a1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span><span class="o">.</span><span class="n">_dim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;dimension not assigned&#39;</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">_dim</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_coeff</span>
    <span class="k">if</span> <span class="n">antisym</span> <span class="ow">and</span> <span class="n">tg</span><span class="o">.</span><span class="n">_dum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># g(i, -i) = -D</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">a1</span><span class="p">)</span><span class="o">*</span><span class="n">coeff</span>
    <span class="k">return</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">_contract_g_with_free_index</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">free_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">tg_free</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">antisym</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper function for _contract</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">free_indices</span><span class="p">:</span>
        <span class="n">ind_free</span> <span class="o">=</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind</span><span class="p">,</span> <span class="n">ipos1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind_free</span> <span class="o">=</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind</span><span class="p">,</span> <span class="n">ipos1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ind1</span> <span class="o">=</span> <span class="o">-</span><span class="n">ind</span>
    <span class="c"># search ind1 in the other component tensors</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ind1</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tx</span><span class="o">.</span><span class="n">_free</span><span class="p">]:</span>
            <span class="k">break</span>
    <span class="c"># replace ind1 with ind_free</span>
    <span class="n">free1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tx</span><span class="o">.</span><span class="n">_free</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">ind1</span><span class="p">:</span>
            <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ind_free</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">free1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">_coeff</span>
    <span class="k">if</span> <span class="n">antisym</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">_is_up</span> <span class="ow">and</span> <span class="n">ind</span> <span class="o">==</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="n">ind</span><span class="o">.</span><span class="n">_is_up</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ind</span> <span class="o">==</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c"># g(i1, i0)*psi(-i1) = -psi(i0)</span>
            <span class="c"># g(-i0, -i1)*psi(i1) = -psi(-i0)</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">free1</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">_dum</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">_coeff</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeff</span><span class="o">*</span><span class="n">res</span>


<span class="k">def</span> <span class="nf">_contract_g_without_free_index</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">free_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">tg_free</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">antisym</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper function for _contract</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">tg_free</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind1m</span> <span class="o">=</span> <span class="o">-</span><span class="n">ind1</span>
    <span class="n">ind2m</span> <span class="o">=</span> <span class="o">-</span><span class="n">ind2</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ty</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ind2m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ty</span><span class="o">.</span><span class="n">_free</span><span class="p">]:</span>
            <span class="k">break</span>
    <span class="c"># ty has the index ind2m</span>
    <span class="n">ty_free</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">_free</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">ty</span><span class="o">.</span><span class="n">_components</span> <span class="o">==</span> <span class="p">[</span><span class="n">g</span><span class="p">]:</span>
        <span class="n">ty_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span>  <span class="n">x</span> <span class="ow">in</span> <span class="n">ty_free</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ind1m</span><span class="p">,</span> <span class="n">ind2m</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ty_indices</span><span class="p">):</span>
            <span class="c"># the two `g` are completely contracted</span>
            <span class="c"># i &lt; k always</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">*</span><span class="n">typ</span><span class="o">.</span><span class="n">_dim</span><span class="o">*</span><span class="n">tg</span><span class="o">.</span><span class="n">_coeff</span><span class="o">*</span><span class="n">ty</span><span class="o">.</span><span class="n">_coeff</span>
            <span class="k">if</span> <span class="n">antisym</span><span class="p">:</span>
                <span class="n">ty_free</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ty_free</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ind1</span><span class="o">.</span><span class="n">_is_up</span> <span class="o">==</span> <span class="n">ind2</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
                    <span class="c"># g(i,j)*g(-i,-j) = g(-i,-j)*g(i,j) = dim</span>
                    <span class="c"># g(i,j)*g(-j,-i) = g(-i,-j)*g(j,i) = -dim</span>
                    <span class="k">if</span> <span class="n">ind1m</span> <span class="o">==</span> <span class="n">ty_free</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># g(-i,j)*g(i,-j) = g(i,-j)^g(-i,j) = -dim</span>
                    <span class="c"># g(-i,j)*g(-j,i) = g(i,-j)*g(j,i) = dim</span>
                    <span class="k">if</span> <span class="n">ind1m</span> <span class="o">==</span> <span class="n">ty_free</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>

            <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">*</span><span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="p">[],[],[],</span> <span class="n">is_canon_bp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="n">free2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ty_freeindices</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ty_free</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ind1m</span> <span class="ow">in</span> <span class="n">ty_freeindices</span><span class="p">:</span>
        <span class="c"># tg has both indices contracted with ty</span>
        <span class="n">free2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="n">cposx</span><span class="p">)</span> <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="n">cposx</span> <span class="ow">in</span> <span class="n">ty</span><span class="o">.</span><span class="n">_free</span> <span class="k">if</span> <span class="n">indx</span> <span class="o">!=</span> <span class="n">ind1m</span> <span class="ow">and</span> <span class="n">indx</span> <span class="o">!=</span> <span class="n">ind2m</span><span class="p">]</span>
        <span class="n">dum2</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">_dum</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ty_free</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">ind1m</span><span class="p">:</span>
                <span class="n">iposx1</span> <span class="o">=</span> <span class="n">iposx</span>
            <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">ind2m</span><span class="p">:</span>
                <span class="n">iposx2</span> <span class="o">=</span> <span class="n">iposx</span>
        <span class="k">if</span> <span class="n">antisym</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ind1</span><span class="o">.</span><span class="n">_is_up</span> <span class="o">==</span> <span class="n">ind2</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iposx1</span> <span class="o">&lt;</span> <span class="n">iposx2</span><span class="p">:</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
                    <span class="n">dum2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iposx1</span><span class="p">,</span> <span class="n">iposx2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dum2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iposx2</span><span class="p">,</span> <span class="n">iposx1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iposx1</span> <span class="o">&gt;</span> <span class="n">iposx2</span><span class="p">:</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
                    <span class="n">dum2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iposx2</span><span class="p">,</span> <span class="n">iposx1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dum2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iposx1</span><span class="p">,</span> <span class="n">iposx2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dum2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iposx1</span><span class="p">,</span> <span class="n">iposx2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># replace ind2m with ind1 in the free indices of ty</span>

        <span class="n">free2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">antisym</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ty_free</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">ind2m</span><span class="p">:</span>
                    <span class="n">free2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ind1</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">free2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ty_free</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="n">ind2m</span><span class="p">:</span>
                    <span class="n">free2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ind1</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">indx</span><span class="o">.</span><span class="n">_is_up</span><span class="p">:</span>
                        <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="n">coeff</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">free2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">indx</span><span class="p">,</span> <span class="n">iposx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">dum2</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">_dum</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">TensMul</span><span class="p">(</span><span class="n">ty</span><span class="o">.</span><span class="n">_coeff</span><span class="p">,</span> <span class="n">ty</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">free2</span><span class="p">,</span> <span class="n">dum2</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">*</span><span class="n">tg</span><span class="o">.</span><span class="n">_coeff</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">tensor_mul</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeff</span><span class="o">*</span><span class="n">res</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/sympylogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SymPy 0.7.2-git documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../sympy.html" >sympy</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013 SymPy Development Team.
      Last updated on Jun 29, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>