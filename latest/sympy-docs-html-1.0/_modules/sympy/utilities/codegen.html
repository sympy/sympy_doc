

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sympy.utilities.codegen &mdash; SymPy 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-core.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-autocomplete.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/utilities.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/external/classy.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-core.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-autocomplete.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../_static/sympy-notailtext-favicon.ico"/>
    <link rel="top" title="SymPy 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SymPy 1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for sympy.utilities.codegen</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">module for generating C, C++, Fortran77, Fortran90, Julia and Octave/Matlab</span>
<span class="sd">routines that evaluate sympy expressions.  This module is work in progress.</span>
<span class="sd">Only the milestones with a &#39;+&#39; character in the list below have been</span>
<span class="sd">completed.</span>

<span class="sd">--- How is sympy.utilities.codegen different from sympy.printing.ccode? ---</span>

<span class="sd">We considered the idea to extend the printing routines for sympy functions in</span>
<span class="sd">such a way that it prints complete compilable code, but this leads to a few</span>
<span class="sd">unsurmountable issues that can only be tackled with dedicated code generator:</span>

<span class="sd">- For C, one needs both a code and a header file, while the printing routines</span>
<span class="sd">  generate just one string. This code generator can be extended to support</span>
<span class="sd">  .pyf files for f2py.</span>

<span class="sd">- SymPy functions are not concerned with programming-technical issues, such</span>
<span class="sd">  as input, output and input-output arguments. Other examples are contiguous</span>
<span class="sd">  or non-contiguous arrays, including headers of other libraries such as gsl</span>
<span class="sd">  or others.</span>

<span class="sd">- It is highly interesting to evaluate several sympy functions in one C</span>
<span class="sd">  routine, eventually sharing common intermediate results with the help</span>
<span class="sd">  of the cse routine. This is more than just printing.</span>

<span class="sd">- From the programming perspective, expressions with constants should be</span>
<span class="sd">  evaluated in the code generator as much as possible. This is different</span>
<span class="sd">  for printing.</span>

<span class="sd">--- Basic assumptions ---</span>

<span class="sd">* A generic Routine data structure describes the routine that must be</span>
<span class="sd">  translated into C/Fortran/... code. This data structure covers all</span>
<span class="sd">  features present in one or more of the supported languages.</span>

<span class="sd">* Descendants from the CodeGen class transform multiple Routine instances</span>
<span class="sd">  into compilable code. Each derived class translates into a specific</span>
<span class="sd">  language.</span>

<span class="sd">* In many cases, one wants a simple workflow. The friendly functions in the</span>
<span class="sd">  last part are a simple api on top of the Routine/CodeGen stuff. They are</span>
<span class="sd">  easier to use, but are less powerful.</span>

<span class="sd">--- Milestones ---</span>

<span class="sd">+ First working version with scalar input arguments, generating C code,</span>
<span class="sd">  tests</span>
<span class="sd">+ Friendly functions that are easier to use than the rigorous</span>
<span class="sd">  Routine/CodeGen workflow.</span>
<span class="sd">+ Integer and Real numbers as input and output</span>
<span class="sd">+ Output arguments</span>
<span class="sd">+ InputOutput arguments</span>
<span class="sd">+ Sort input/output arguments properly</span>
<span class="sd">+ Contiguous array arguments (numpy matrices)</span>
<span class="sd">+ Also generate .pyf code for f2py (in autowrap module)</span>
<span class="sd">+ Isolate constants and evaluate them beforehand in double precision</span>
<span class="sd">+ Fortran 90</span>
<span class="sd">+ Octave/Matlab</span>

<span class="sd">- Common Subexpression Elimination</span>
<span class="sd">- User defined comments in the generated code</span>
<span class="sd">- Optional extra include lines for libraries/objects that can eval special</span>
<span class="sd">  functions</span>
<span class="sd">- Test other C compilers and libraries: gcc, tcc, libtcc, gcc+gsl, ...</span>
<span class="sd">- Contiguous array arguments (sympy matrices)</span>
<span class="sd">- Non-contiguous array arguments (sympy matrices)</span>
<span class="sd">- ccode must raise an error when it encounters something that can not be</span>
<span class="sd">  translated into c. ccode(integrate(sin(x)/x, x)) does not make sense.</span>
<span class="sd">- Complex numbers as input and output</span>
<span class="sd">- A default complex datatype</span>
<span class="sd">- Include extra information in the header: date, user, hostname, sha1</span>
<span class="sd">  hash, ...</span>
<span class="sd">- Fortran 77</span>
<span class="sd">- C++</span>
<span class="sd">- Python</span>
<span class="sd">- Julia</span>
<span class="sd">- ...</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">sympy_version</span>
<span class="kn">from</span> <span class="nn">sympy.core</span> <span class="kn">import</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Equality</span><span class="p">,</span> <span class="n">Function</span>
<span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="kn">import</span> <span class="n">is_sequence</span><span class="p">,</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">sympy.printing.codeprinter</span> <span class="kn">import</span> <span class="n">AssignmentError</span>
<span class="kn">from</span> <span class="nn">sympy.printing.ccode</span> <span class="kn">import</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">CCodePrinter</span>
<span class="kn">from</span> <span class="nn">sympy.printing.fcode</span> <span class="kn">import</span> <span class="n">fcode</span><span class="p">,</span> <span class="n">FCodePrinter</span>
<span class="kn">from</span> <span class="nn">sympy.printing.julia</span> <span class="kn">import</span> <span class="n">julia_code</span><span class="p">,</span> <span class="n">JuliaCodePrinter</span>
<span class="kn">from</span> <span class="nn">sympy.printing.octave</span> <span class="kn">import</span> <span class="n">octave_code</span><span class="p">,</span> <span class="n">OctaveCodePrinter</span>
<span class="kn">from</span> <span class="nn">sympy.tensor</span> <span class="kn">import</span> <span class="n">Idx</span><span class="p">,</span> <span class="n">Indexed</span><span class="p">,</span> <span class="n">IndexedBase</span>
<span class="kn">from</span> <span class="nn">sympy.matrices</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MatrixSymbol</span><span class="p">,</span> <span class="n">ImmutableMatrix</span><span class="p">,</span> <span class="n">MatrixBase</span><span class="p">,</span>
                            <span class="n">MatrixExpr</span><span class="p">,</span> <span class="n">MatrixSlice</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># description of routines</span>
    <span class="s2">&quot;Routine&quot;</span><span class="p">,</span> <span class="s2">&quot;DataType&quot;</span><span class="p">,</span> <span class="s2">&quot;default_datatypes&quot;</span><span class="p">,</span> <span class="s2">&quot;get_default_datatype&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Argument&quot;</span><span class="p">,</span> <span class="s2">&quot;InputArgument&quot;</span><span class="p">,</span> <span class="s2">&quot;Result&quot;</span><span class="p">,</span>
    <span class="c1"># routines -&gt; code</span>
    <span class="s2">&quot;CodeGen&quot;</span><span class="p">,</span> <span class="s2">&quot;CCodeGen&quot;</span><span class="p">,</span> <span class="s2">&quot;FCodeGen&quot;</span><span class="p">,</span> <span class="s2">&quot;JuliaCodeGen&quot;</span><span class="p">,</span> <span class="s2">&quot;OctaveCodeGen&quot;</span><span class="p">,</span>
    <span class="c1"># friendly functions</span>
    <span class="s2">&quot;codegen&quot;</span><span class="p">,</span> <span class="s2">&quot;make_routine&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1">#</span>
<span class="c1"># Description of routines</span>
<span class="c1">#</span>


<div class="viewcode-block" id="Routine"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.Routine">[docs]</a><span class="k">class</span> <span class="nc">Routine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic description of evaluation routine for set of expressions.</span>

<span class="sd">    A CodeGen class can translate instances of this class into code in a</span>
<span class="sd">    particular language.  The routine specification covers all the features</span>
<span class="sd">    present in these languages.  The CodeGen part must raise an exception</span>
<span class="sd">    when certain features are not present in the target language.  For</span>
<span class="sd">    example, multiple return values are possible in Python, but not in C or</span>
<span class="sd">    Fortran.  Another example: Fortran and Python support complex numbers,</span>
<span class="sd">    while C does not.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">local_vars</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Routine instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the routine.</span>

<span class="sd">        arguments : list of Arguments</span>
<span class="sd">            These are things that appear in arguments of a routine, often</span>
<span class="sd">            appearing on the right-hand side of a function call.  These are</span>
<span class="sd">            commonly InputArguments but in some languages, they can also be</span>
<span class="sd">            OutputArguments or InOutArguments (e.g., pass-by-reference in C</span>
<span class="sd">            code).</span>

<span class="sd">        results : list of Results</span>
<span class="sd">            These are the return values of the routine, often appearing on</span>
<span class="sd">            the left-hand side of a function call.  The difference between</span>
<span class="sd">            Results and OutputArguments and when you should use each is</span>
<span class="sd">            language-specific.</span>

<span class="sd">        local_vars : list of Symbols</span>
<span class="sd">            These are used internally by the routine.</span>

<span class="sd">        global_vars : list of Symbols</span>
<span class="sd">            Variables which will not be passed into the function.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># extract all input symbols and all symbols appearing in an expression</span>
        <span class="n">input_symbols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">OutputArgument</span><span class="p">):</span>
                <span class="n">symbols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">InputArgument</span><span class="p">):</span>
                <span class="n">input_symbols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">InOutArgument</span><span class="p">):</span>
                <span class="n">input_symbols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">symbols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown Routine argument: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown Routine result: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">symbols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">)</span>

        <span class="c1"># Check that all symbols in the expressions are covered by</span>
        <span class="c1"># InputArguments/InOutArguments---subset because user could</span>
        <span class="c1"># specify additional (unused) InputArguments or local_vars.</span>
        <span class="n">notcovered</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
            <span class="n">input_symbols</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">local_vars</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">global_vars</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">notcovered</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">([]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symbols needed for output are not in input &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">notcovered</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_vars</span> <span class="o">=</span> <span class="n">local_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_vars</span> <span class="o">=</span> <span class="n">global_vars</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s2">&quot;({name!r}, {arguments}, {results}, {local_vars}, {global_vars})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Routine.variables"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.Routine.variables">[docs]</a>    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of all variables possibly used in the routine.</span>

<span class="sd">        For routines with unnamed return values, the dummies that may or</span>
<span class="sd">        may not be used will be included in the set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">result_var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Routine.result_variables"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.Routine.result_variables">[docs]</a>    <span class="k">def</span> <span class="nf">result_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of OutputArgument, InOutArgument and Result.</span>

<span class="sd">        If return values are present, they are at the end ot the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">OutputArgument</span><span class="p">,</span> <span class="n">InOutArgument</span><span class="p">))]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span>

</div></div>
<div class="viewcode-block" id="DataType"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.DataType">[docs]</a><span class="k">class</span> <span class="nc">DataType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Holds strings for a certain datatype in different languages.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">pyname</span><span class="p">,</span> <span class="n">jlname</span><span class="p">,</span> <span class="n">octname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cname</span> <span class="o">=</span> <span class="n">cname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyname</span> <span class="o">=</span> <span class="n">pyname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jlname</span> <span class="o">=</span> <span class="n">jlname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octname</span> <span class="o">=</span> <span class="n">octname</span>

</div>
<span class="n">default_datatypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="n">DataType</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;INTEGER*4&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="n">DataType</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;REAL*8&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="get_default_datatype"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.get_default_datatype">[docs]</a><span class="k">def</span> <span class="nf">get_default_datatype</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Derives an appropriate datatype based on the expression.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_datatypes</span><span class="p">[</span><span class="s2">&quot;int&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">MatrixBase</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default_datatypes</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">default_datatypes</span><span class="p">[</span><span class="s2">&quot;int&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_datatypes</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">]</span>

</div>
<span class="k">class</span> <span class="nc">Variable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a typed variable.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        name : Symbol or MatrixSymbol</span>

<span class="sd">        datatype : optional</span>
<span class="sd">            When not given, the data type will be guessed based on the</span>
<span class="sd">            assumptions on the symbol argument.</span>

<span class="sd">        dimension : sequence containing tupes, optional</span>
<span class="sd">            If present, the argument is interpreted as an array, where this</span>
<span class="sd">            sequence of tuples specifies (lower, upper) bounds for each</span>
<span class="sd">            index of the array.</span>

<span class="sd">        precision : int, optional</span>
<span class="sd">            Controls the precision of floating point constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">MatrixSymbol</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The first argument must be a sympy symbol.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="n">get_default_datatype</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="n">DataType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The (optional) `datatype&#39; argument must be an &quot;</span>
                            <span class="s2">&quot;instance of the DataType class.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dimensions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;The dimension argument must be a sequence of tuples&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">datatype</span><span class="o">.</span><span class="n">cname</span><span class="p">,</span>
            <span class="s1">&#39;FORTRAN&#39;</span><span class="p">:</span> <span class="n">datatype</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="s1">&#39;JULIA&#39;</span><span class="p">:</span> <span class="n">datatype</span><span class="o">.</span><span class="n">jlname</span><span class="p">,</span>
            <span class="s1">&#39;OCTAVE&#39;</span><span class="p">:</span> <span class="n">datatype</span><span class="o">.</span><span class="n">octname</span><span class="p">,</span>
            <span class="s1">&#39;PYTHON&#39;</span><span class="p">:</span> <span class="n">datatype</span><span class="o">.</span><span class="n">pyname</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="k">def</span> <span class="nf">get_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the datatype string for the requested language.</span>

<span class="sd">        Examples</span>
<span class="sd">        ========</span>

<span class="sd">        &gt;&gt;&gt; from sympy import Symbol</span>
<span class="sd">        &gt;&gt;&gt; from sympy.utilities.codegen import Variable</span>
<span class="sd">        &gt;&gt;&gt; x = Variable(Symbol(&#39;x&#39;))</span>
<span class="sd">        &gt;&gt;&gt; x.get_datatype(&#39;c&#39;)</span>
<span class="sd">        &#39;double&#39;</span>
<span class="sd">        &gt;&gt;&gt; x.get_datatype(&#39;fortran&#39;)</span>
<span class="sd">        &#39;REAL*8&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span><span class="p">[</span><span class="n">language</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Has datatypes for languages: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span><span class="p">))</span>


<div class="viewcode-block" id="Argument"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.Argument">[docs]</a><span class="k">class</span> <span class="nc">Argument</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An abstract Argument data structure: a name and a data type.</span>

<span class="sd">    This structure is refined in the descendants below.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<span class="k">class</span> <span class="nc">InputArgument</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ResultBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all &quot;outgoing&quot; information from a routine.</span>

<span class="sd">    Objects of this class stores a sympy expression, and a sympy object</span>
<span class="sd">    representing a result variable that will be used in the generated code</span>
<span class="sd">    only if necessary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">result_var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_var</span> <span class="o">=</span> <span class="n">result_var</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_var</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>

<span class="k">class</span> <span class="nc">OutputArgument</span><span class="p">(</span><span class="n">Argument</span><span class="p">,</span> <span class="n">ResultBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;OutputArgument are always initialized in the routine.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">result_var</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        name : Symbol, MatrixSymbol</span>
<span class="sd">            The name of this variable.  When used for code generation, this</span>
<span class="sd">            might appear, for example, in the prototype of function in the</span>
<span class="sd">            argument list.</span>

<span class="sd">        result_var : Symbol, Indexed</span>
<span class="sd">            Something that can be used to assign a value to this variable.</span>
<span class="sd">            Typically the same as `name` but for Indexed this should be e.g.,</span>
<span class="sd">            &quot;y[i]&quot; whereas `name` should be the Symbol &quot;y&quot;.</span>

<span class="sd">        expr : object</span>
<span class="sd">            The expression that should be output, typically a SymPy</span>
<span class="sd">            expression.</span>

<span class="sd">        datatype : optional</span>
<span class="sd">            When not given, the data type will be guessed based on the</span>
<span class="sd">            assumptions on the symbol argument.</span>

<span class="sd">        dimension : sequence containing tupes, optional</span>
<span class="sd">            If present, the argument is interpreted as an array, where this</span>
<span class="sd">            sequence of tuples specifies (lower, upper) bounds for each</span>
<span class="sd">            index of the array.</span>

<span class="sd">        precision : int, optional</span>
<span class="sd">            Controls the precision of floating point constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Argument</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
        <span class="n">ResultBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">result_var</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_var</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>

<span class="k">class</span> <span class="nc">InOutArgument</span><span class="p">(</span><span class="n">Argument</span><span class="p">,</span> <span class="n">ResultBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;InOutArgument are never initialized in the routine.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">result_var</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">datatype</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="n">get_default_datatype</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">Argument</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
        <span class="n">ResultBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">result_var</span><span class="p">)</span>
    <span class="n">__init__</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">OutputArgument</span><span class="o">.</span><span class="n">__init__</span><span class="o">.</span><span class="n">__doc__</span>


    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_var</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>

<div class="viewcode-block" id="Result"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.Result">[docs]</a><span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="n">Variable</span><span class="p">,</span> <span class="n">ResultBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An expression for a return value.</span>

<span class="sd">    The name result is used to avoid conflicts with the reserved word</span>
<span class="sd">    &quot;return&quot; in the python language.  It is also shorter than ReturnValue.</span>

<span class="sd">    These may or may not need a name in the destination (e.g., &quot;return(x*y)&quot;</span>
<span class="sd">    might return a value without ever naming it).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">result_var</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">dimensions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a return value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        expr : SymPy expression</span>

<span class="sd">        name : Symbol, MatrixSymbol, optional</span>
<span class="sd">            The name of this return variable.  When used for code generation,</span>
<span class="sd">            this might appear, for example, in the prototype of function in a</span>
<span class="sd">            list of return values.  A dummy name is generated if omitted.</span>

<span class="sd">        result_var : Symbol, Indexed, optional</span>
<span class="sd">            Something that can be used to assign a value to this variable.</span>
<span class="sd">            Typically the same as `name` but for Indexed this should be e.g.,</span>
<span class="sd">            &quot;y[i]&quot; whereas `name` should be the Symbol &quot;y&quot;.  Defaults to</span>
<span class="sd">            `name` if omitted.</span>

<span class="sd">        datatype : optional</span>
<span class="sd">            When not given, the data type will be guessed based on the</span>
<span class="sd">            assumptions on the symbol argument.</span>

<span class="sd">        dimension : sequence containing tupes, optional</span>
<span class="sd">            If present, this variable is interpreted as an array,</span>
<span class="sd">            where this sequence of tuples specifies (lower, upper)</span>
<span class="sd">            bounds for each index of the array.</span>

<span class="sd">        precision : int, optional</span>
<span class="sd">            Controls the precision of floating point constants.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">MatrixBase</span><span class="p">,</span> <span class="n">MatrixExpr</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The first argument must be a sympy expression.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;result_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">MatrixBase</span><span class="p">,</span> <span class="n">MatrixExpr</span><span class="p">)):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">MatrixSymbol</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result_var</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">result_var</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">Variable</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span>
                          <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span>
        <span class="n">ResultBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">result_var</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Transformation of routine objects into code</span>
<span class="c1">#</span>
</div>
<div class="viewcode-block" id="CodeGen"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CodeGen">[docs]</a><span class="k">class</span> <span class="nc">CodeGen</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract class for the code generators.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s2">&quot;project&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a code generator.</span>

<span class="sd">        Derived classes will offer more options that affect the generated</span>
<span class="sd">        code.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

<div class="viewcode-block" id="CodeGen.routine"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CodeGen.routine">[docs]</a>    <span class="k">def</span> <span class="nf">routine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates an Routine object that is appropriate for this language.</span>

<span class="sd">        This implementation is appropriate for at least C/Fortran.  Subclasses</span>
<span class="sd">        can override this if necessary.</span>

<span class="sd">        Here, we assume at most one return value (the l-value) which must be</span>
<span class="sd">        scalar.  Additional outputs are OutputArguments (e.g., pointers on</span>
<span class="sd">        right-hand-side or pass-by-reference).  Matrices are always returned</span>
<span class="sd">        via OutputArguments.  If ``argument_sequence`` is None, arguments will</span>
<span class="sd">        be ordered alphabetically, but with all InputArguments first, and then</span>
<span class="sd">        OutputArgument and InOutArguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">is_sequence</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">MatrixBase</span><span class="p">,</span> <span class="n">MatrixExpr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No expression given&quot;</span><span class="p">)</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="c1"># local variables</span>
        <span class="n">local_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Idx</span><span class="p">)])</span>

        <span class="c1"># global variables</span>
        <span class="n">global_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">global_vars</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">global_vars</span><span class="p">)</span>

        <span class="c1"># symbols that should be arguments</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">expressions</span><span class="o">.</span><span class="n">free_symbols</span> <span class="o">-</span> <span class="n">local_vars</span> <span class="o">-</span> <span class="n">global_vars</span>
        <span class="c1"># Decide whether to use output argument or return value</span>
        <span class="n">return_val</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Equality</span><span class="p">):</span>
                <span class="n">out_arg</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rhs</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="n">Indexed</span><span class="p">):</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span> <span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">label</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">):</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="n">MatrixSymbol</span><span class="p">):</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span> <span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Only Indexed, Symbol, or MatrixSymbol &quot;</span>
                                       <span class="s2">&quot;can define output arguments.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
                    <span class="n">output_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">InOutArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">out_arg</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">OutputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">out_arg</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span>

                <span class="c1"># avoid duplicate arguments</span>
                <span class="n">symbols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">ImmutableMatrix</span><span class="p">,</span> <span class="n">MatrixSlice</span><span class="p">)):</span>
                <span class="c1"># Create a &quot;dummy&quot; MatrixSymbol to use as the Output arg</span>
                <span class="n">out_arg</span> <span class="o">=</span> <span class="n">MatrixSymbol</span><span class="p">(</span><span class="s1">&#39;out_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">expr</span><span class="p">)),</span> <span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">S</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
                <span class="n">output_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">OutputArgument</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="n">out_arg</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">return_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

        <span class="n">arg_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># setup input argument list</span>
        <span class="n">array_symbols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Indexed</span><span class="p">):</span>
            <span class="n">array_symbols</span><span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">MatrixSymbol</span><span class="p">):</span>
            <span class="n">array_symbols</span><span class="p">[</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">array_symbols</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">array_symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">S</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="n">dims</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">))</span>

        <span class="n">output_args</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">arg_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">output_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">argument_sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># if the user has supplied IndexedBase instances, we&#39;ll accept that</span>
            <span class="n">new_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">IndexedBase</span><span class="p">):</span>
                    <span class="n">new_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">argument_sequence</span> <span class="o">=</span> <span class="n">new_sequence</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg_list</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Argument list didn&#39;t specify: {0} &quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]))</span>
                <span class="k">raise</span> <span class="n">CodeGenArgumentListError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>

            <span class="c1"># create redundant arguments to produce the requested sequence</span>
            <span class="n">name_arg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg_list</span><span class="p">])</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_arg_dict</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="n">new_args</span>

        <span class="k">return</span> <span class="n">Routine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">,</span> <span class="n">return_val</span><span class="p">,</span> <span class="n">local_vars</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGen.write"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CodeGen.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">to_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes all the source code files for the given routines.</span>

<span class="sd">        The generated source is returned as a list of (filename, contents)</span>
<span class="sd">        tuples, or is written to files (see below).  Each filename consists</span>
<span class="sd">        of the given prefix, appended with an appropriate extension.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        routines : list</span>
<span class="sd">            A list of Routine instances to be written</span>

<span class="sd">        prefix : string</span>
<span class="sd">            The prefix for the output files</span>

<span class="sd">        to_files : bool, optional</span>
<span class="sd">            When True, the output is written to files.  Otherwise, a list</span>
<span class="sd">            of (filename, contents) tuples is returned.  [default: False]</span>

<span class="sd">        header : bool, optional</span>
<span class="sd">            When True, a header comment is included on top of each source</span>
<span class="sd">            file. [default: True]</span>

<span class="sd">        empty : bool, optional</span>
<span class="sd">            When True, empty lines are included to structure the source</span>
<span class="sd">            files. [default: True]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">to_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dump_fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_fns</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dump_fn</span><span class="o">.</span><span class="n">extension</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">dump_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dump_fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_fns</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dump_fn</span><span class="o">.</span><span class="n">extension</span><span class="p">)</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
                <span class="n">dump_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="CodeGen.dump_code"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CodeGen.dump_code">[docs]</a>    <span class="k">def</span> <span class="nf">dump_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the code by calling language specific methods.</span>

<span class="sd">        The generated file contains all the definitions of the routines in</span>
<span class="sd">        low-level code and refers to the header file if appropriate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        routines : list</span>
<span class="sd">            A list of Routine instances.</span>

<span class="sd">        f : file-like</span>
<span class="sd">            Where to write the file.</span>

<span class="sd">        prefix : string</span>
<span class="sd">            The filename prefix, used to refer to the proper header file.</span>
<span class="sd">            Only the basename of the prefix is used.</span>

<span class="sd">        header : bool, optional</span>
<span class="sd">            When True, a header comment is included on top of each source</span>
<span class="sd">            file.  [default : True]</span>

<span class="sd">        empty : bool, optional</span>
<span class="sd">            When True, empty lines are included to structure the source</span>
<span class="sd">            files.  [default : True]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">code_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_statements</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">routine</span> <span class="ow">in</span> <span class="n">routines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_routine_opening</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_arguments</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_globals</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_locals</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_printer</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_routine_ending</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>

        <span class="n">code_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent_code</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_lines</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">code_lines</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_header</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">code_lines</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">code_lines</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code_lines</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">CodeGenError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CodeGenArgumentListError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">missing_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="n">header_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Code generated with sympy </span><span class="si">%(version)s</span><span class="s2"></span>

<span class="s2">See http://www.sympy.org/ for more information.</span>

<span class="s2">This file is part of &#39;</span><span class="si">%(project)s</span><span class="s2">&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="CCodeGen"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CCodeGen">[docs]</a><span class="k">class</span> <span class="nc">CCodeGen</span><span class="p">(</span><span class="n">CodeGen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for C code.</span>

<span class="sd">    The .write() method inherited from CodeGen will output a code file and</span>
<span class="sd">    an interface file, &lt;prefix&gt;.c and &lt;prefix&gt;.h respectively.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">code_extension</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>
    <span class="n">interface_extension</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span>

    <span class="k">def</span> <span class="nf">_get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a common header for the generated files.&quot;&quot;&quot;</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">78</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">header_comment</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">sympy_version</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; *</span><span class="si">%s</span><span class="s2">*</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">76</span><span class="p">))</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">78</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_lines</span>

<div class="viewcode-block" id="CCodeGen.get_prototype"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CCodeGen.get_prototype">[docs]</a>    <span class="k">def</span> <span class="nf">get_prototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a string for the function prototype of the routine.</span>

<span class="sd">        If the routine has multiple result objects, an CodeGenError is</span>
<span class="sd">        raised.</span>

<span class="sd">        See: http://en.wikipedia.org/wiki/Function_prototype</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;C only supports a single or no return value.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="s2">&quot;void&quot;</span>

        <span class="n">type_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ccode</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ResultBase</span><span class="p">):</span>
                <span class="n">type_args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="s2">&quot;*</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">type_args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">type_args</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">routine</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_preprocessor_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#include </span><span class="se">\&quot;</span><span class="si">%s</span><span class="s2">.h</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#include &lt;math.h&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_get_routine_opening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prototype</span><span class="p">(</span><span class="n">routine</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> {</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prototype</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_declare_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="c1"># arguments are declared in prototype</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_declare_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="c1"># global variables are not explicitly declared within C functions</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_declare_locals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="c1"># loop variables are declared in loop statement</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_call_printer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Compose a list of symbols to be dereferenced in the function</span>
        <span class="c1"># body. These are the arguments that were passed by a reference</span>
        <span class="c1"># pointer, excluding arrays.</span>
        <span class="n">dereference</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ResultBase</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="n">dereference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">return_val</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">result_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">routine</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_result&quot;</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{0} {1};</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">assign_to</span><span class="p">)))</span>
                <span class="n">return_val</span> <span class="o">=</span> <span class="n">assign_to</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">result_var</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">constants</span><span class="p">,</span> <span class="n">not_c</span><span class="p">,</span> <span class="n">c_expr</span> <span class="o">=</span> <span class="n">ccode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">assign_to</span><span class="o">=</span><span class="n">assign_to</span><span class="p">,</span> <span class="n">dereference</span><span class="o">=</span><span class="n">dereference</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AssignmentError</span><span class="p">:</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">result_var</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">assign_to</span><span class="p">)))</span>
                <span class="n">constants</span><span class="p">,</span> <span class="n">not_c</span><span class="p">,</span> <span class="n">c_expr</span> <span class="o">=</span> <span class="n">ccode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">assign_to</span><span class="o">=</span><span class="n">assign_to</span><span class="p">,</span> <span class="n">dereference</span><span class="o">=</span><span class="n">dereference</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;double const </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c_expr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   return </span><span class="si">%s</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">return_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_indent_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codelines</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">CCodePrinter</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">indent_code</span><span class="p">(</span><span class="n">codelines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_routine_ending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="CCodeGen.dump_c"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CCodeGen.dump_c">[docs]</a>    <span class="k">def</span> <span class="nf">dump_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_code</span><span class="p">(</span><span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span></div>
    <span class="n">dump_c</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">code_extension</span>
    <span class="n">dump_c</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">CodeGen</span><span class="o">.</span><span class="n">dump_code</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="CCodeGen.dump_h"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.CCodeGen.dump_h">[docs]</a>    <span class="k">def</span> <span class="nf">dump_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the C header file.</span>

<span class="sd">        This file contains all the function declarations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        routines : list</span>
<span class="sd">            A list of Routine instances.</span>

<span class="sd">        f : file-like</span>
<span class="sd">            Where to write the file.</span>

<span class="sd">        prefix : string</span>
<span class="sd">            The filename prefix, used to construct the include guards.</span>
<span class="sd">            Only the basename of the prefix is used.</span>

<span class="sd">        header : bool, optional</span>
<span class="sd">            When True, a header comment is included on top of each source</span>
<span class="sd">            file.  [default : True]</span>

<span class="sd">        empty : bool, optional</span>
<span class="sd">            When True, empty lines are included to structure the source</span>
<span class="sd">            files.  [default : True]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_header</span><span class="p">()),</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">guard_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__</span><span class="si">%s</span><span class="s2">__H&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="c1"># include guards</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;#ifndef </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">guard_name</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;#define </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">guard_name</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># declaration of the function prototypes</span>
        <span class="k">for</span> <span class="n">routine</span> <span class="ow">in</span> <span class="n">routines</span><span class="p">:</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prototype</span><span class="p">(</span><span class="n">routine</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">prototype</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># end if include guards</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;#endif&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
    <span class="n">dump_h</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">interface_extension</span>

    <span class="c1"># This list of dump functions is used by CodeGen.write to know which dump</span>
    <span class="c1"># functions it has to call.</span>
    <span class="n">dump_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">dump_c</span><span class="p">,</span> <span class="n">dump_h</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="FCodeGen"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.FCodeGen">[docs]</a><span class="k">class</span> <span class="nc">FCodeGen</span><span class="p">(</span><span class="n">CodeGen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for Fortran 95 code</span>

<span class="sd">    The .write() method inherited from CodeGen will output a code file and</span>
<span class="sd">    an interface file, &lt;prefix&gt;.f90 and &lt;prefix&gt;.h respectively.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">code_extension</span> <span class="o">=</span> <span class="s2">&quot;f90&quot;</span>
    <span class="n">interface_extension</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;project&#39;</span><span class="p">):</span>
        <span class="n">CodeGen</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the symbol as fcode prints it.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fcode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a common header for the generated files.&quot;&quot;&quot;</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">78</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">header_comment</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">sympy_version</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;!*</span><span class="si">%s</span><span class="s2">*</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">76</span><span class="p">))</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">78</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_preprocessor_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_routine_opening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the opening statements of the fortran routine.&quot;&quot;&quot;</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span>
                <span class="s2">&quot;Fortran only supports a single or no return value.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;fortran&#39;</span><span class="p">))</span>
            <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;subroutine&quot;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>

        <span class="n">call_sig</span> <span class="o">=</span> <span class="s2">&quot;{0}({1})</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># Fortran 95 requires all lines be less than 132 characters, so wrap</span>
        <span class="c1"># this line before appending.</span>
        <span class="n">call_sig</span> <span class="o">=</span> <span class="s1">&#39; &amp;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">call_sig</span><span class="p">,</span>
                                             <span class="n">width</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                                             <span class="n">break_long_words</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call_sig</span><span class="p">)</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">)]</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;implicit none</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_list</span>

    <span class="k">def</span> <span class="nf">_declare_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="c1"># argument type declarations</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">array_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scalar_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">InputArgument</span><span class="p">):</span>
                <span class="n">typeinfo</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, intent(in)&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;fortran&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">InOutArgument</span><span class="p">):</span>
                <span class="n">typeinfo</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, intent(inout)&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;fortran&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">OutputArgument</span><span class="p">):</span>
                <span class="n">typeinfo</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, intent(out)&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">get_datatype</span><span class="p">(</span><span class="s1">&#39;fortran&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Unkown Argument type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

            <span class="n">fprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span>

            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="c1"># fortran arrays start at 1</span>
                <span class="n">dimstr</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">fprint</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fprint</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>
                <span class="n">typeinfo</span> <span class="o">+=</span> <span class="s2">&quot;, dimension(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">dimstr</span>
                <span class="n">array_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> :: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typeinfo</span><span class="p">,</span> <span class="n">fprint</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scalar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> :: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typeinfo</span><span class="p">,</span> <span class="n">fprint</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

        <span class="c1"># scalars first, because they can be used in array declarations</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scalar_list</span><span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">array_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">code_list</span>

    <span class="k">def</span> <span class="nf">_declare_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="c1"># Global variables not explicitly declared within Fortran 90 functions.</span>
        <span class="c1"># Note: a future F77 mode may need to generate &quot;common&quot; blocks.</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_declare_locals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">local_vars</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">typeinfo</span> <span class="o">=</span> <span class="n">get_default_datatype</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> :: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">typeinfo</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">code_list</span>

    <span class="k">def</span> <span class="nf">_get_routine_ending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the closing statements of the fortran routine.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;end function</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;end subroutine</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="FCodeGen.get_interface"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.FCodeGen.get_interface">[docs]</a>    <span class="k">def</span> <span class="nf">get_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a string for the function interface.</span>

<span class="sd">        The routine should have a single result object, which can be None.</span>
<span class="sd">        If the routine has multiple result objects, a CodeGenError is</span>
<span class="sd">        raised.</span>

<span class="sd">        See: http://en.wikipedia.org/wiki/Function_prototype</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;interface</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">]</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_routine_opening</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_arguments</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_routine_ending</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
        <span class="n">prototype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;end interface</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_call_printer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">declarations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">result_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">routine</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">OutputArgument</span><span class="p">,</span> <span class="n">InOutArgument</span><span class="p">)):</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">result_var</span>

            <span class="n">constants</span><span class="p">,</span> <span class="n">not_fortran</span><span class="p">,</span> <span class="n">f_expr</span> <span class="o">=</span> <span class="n">fcode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">assign_to</span><span class="o">=</span><span class="n">assign_to</span><span class="p">,</span> <span class="n">source_format</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">get_default_datatype</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">declarations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, parameter :: </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">not_fortran</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">get_default_datatype</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">func</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">declarations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> :: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">declarations</span> <span class="o">+</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_indent_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codelines</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">FCodePrinter</span><span class="p">({</span><span class="s1">&#39;source_format&#39;</span><span class="p">:</span> <span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="s1">&#39;human&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">indent_code</span><span class="p">(</span><span class="n">codelines</span><span class="p">)</span>

<div class="viewcode-block" id="FCodeGen.dump_f95"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.FCodeGen.dump_f95">[docs]</a>    <span class="k">def</span> <span class="nf">dump_f95</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># check that symbols are unique with ignorecase</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">routines</span><span class="p">:</span>
            <span class="n">lowercase</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">variables</span><span class="p">])</span>
            <span class="n">orig_case</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">variables</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowercase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_case</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Fortran ignores case. Got symbols: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">variables</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_code</span><span class="p">(</span><span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span></div>
    <span class="n">dump_f95</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">code_extension</span>
    <span class="n">dump_f95</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">CodeGen</span><span class="o">.</span><span class="n">dump_code</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="FCodeGen.dump_h"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.FCodeGen.dump_h">[docs]</a>    <span class="k">def</span> <span class="nf">dump_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the interface to a header file.</span>

<span class="sd">        This file contains all the function declarations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        routines : list</span>
<span class="sd">            A list of Routine instances.</span>

<span class="sd">        f : file-like</span>
<span class="sd">            Where to write the file.</span>

<span class="sd">        prefix : string</span>
<span class="sd">            The filename prefix.</span>

<span class="sd">        header : bool, optional</span>
<span class="sd">            When True, a header comment is included on top of each source</span>
<span class="sd">            file.  [default : True]</span>

<span class="sd">        empty : bool, optional</span>
<span class="sd">            When True, empty lines are included to structure the source</span>
<span class="sd">            files.  [default : True]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_header</span><span class="p">()),</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># declaration of the function prototypes</span>
        <span class="k">for</span> <span class="n">routine</span> <span class="ow">in</span> <span class="n">routines</span><span class="p">:</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">(</span><span class="n">routine</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>
    <span class="n">dump_h</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">interface_extension</span>

    <span class="c1"># This list of dump functions is used by CodeGen.write to know which dump</span>
    <span class="c1"># functions it has to call.</span>
    <span class="n">dump_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">dump_f95</span><span class="p">,</span> <span class="n">dump_h</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="JuliaCodeGen"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.JuliaCodeGen">[docs]</a><span class="k">class</span> <span class="nc">JuliaCodeGen</span><span class="p">(</span><span class="n">CodeGen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for Julia code.</span>

<span class="sd">    The .write() method inherited from CodeGen will output a code file</span>
<span class="sd">    &lt;prefix&gt;.jl.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">code_extension</span> <span class="o">=</span> <span class="s2">&quot;jl&quot;</span>

<div class="viewcode-block" id="JuliaCodeGen.routine"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.JuliaCodeGen.routine">[docs]</a>    <span class="k">def</span> <span class="nf">routine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specialized Routine creation for Julia.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">is_sequence</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">MatrixBase</span><span class="p">,</span> <span class="n">MatrixExpr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No expression given&quot;</span><span class="p">)</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="c1"># local variables</span>
        <span class="n">local_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Idx</span><span class="p">)])</span>

        <span class="c1"># global variables</span>
        <span class="n">global_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">global_vars</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">global_vars</span><span class="p">)</span>

        <span class="c1"># symbols that should be arguments</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">expressions</span><span class="o">.</span><span class="n">free_symbols</span> <span class="o">-</span> <span class="n">local_vars</span> <span class="o">-</span> <span class="n">global_vars</span>

        <span class="c1"># Julia supports multiple return values</span>
        <span class="n">return_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expressions</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Equality</span><span class="p">):</span>
                <span class="n">out_arg</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rhs</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="n">Indexed</span><span class="p">):</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span> <span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">label</span>
                    <span class="n">output_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InOutArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">out_arg</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dims</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="p">(</span><span class="n">Indexed</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">MatrixSymbol</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Only Indexed, Symbol, or MatrixSymbol &quot;</span>
                                       <span class="s2">&quot;can define output arguments.&quot;</span><span class="p">)</span>

                <span class="n">return_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">result_var</span><span class="o">=</span><span class="n">out_arg</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
                    <span class="c1"># this is a pure output: remove from the symbols list, so</span>
                    <span class="c1"># it doesn&#39;t become an input.</span>
                    <span class="n">symbols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we have no name for this output</span>
                <span class="n">return_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># setup input argument list</span>
        <span class="n">output_args</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">arg_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_args</span><span class="p">)</span>
        <span class="n">array_symbols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Indexed</span><span class="p">):</span>
            <span class="n">array_symbols</span><span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">MatrixSymbol</span><span class="p">):</span>
            <span class="n">array_symbols</span><span class="p">[</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">argument_sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># if the user has supplied IndexedBase instances, we&#39;ll accept that</span>
            <span class="n">new_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">IndexedBase</span><span class="p">):</span>
                    <span class="n">new_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">argument_sequence</span> <span class="o">=</span> <span class="n">new_sequence</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg_list</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Argument list didn&#39;t specify: {0} &quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]))</span>
                <span class="k">raise</span> <span class="n">CodeGenArgumentListError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>

            <span class="c1"># create redundant arguments to produce the requested sequence</span>
            <span class="n">name_arg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg_list</span><span class="p">])</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_arg_dict</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="n">new_args</span>

        <span class="k">return</span> <span class="n">Routine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">,</span> <span class="n">return_vals</span><span class="p">,</span> <span class="n">local_vars</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the symbol appropriately.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">julia_code</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a common header for the generated files.&quot;&quot;&quot;</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">header_comment</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">sympy_version</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#   </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_preprocessor_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_routine_opening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the opening statements of the routine.&quot;&quot;&quot;</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;function &quot;</span><span class="p">)</span>

        <span class="c1"># Inputs</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">OutputArgument</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Julia: invalid argument of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">InputArgument</span><span class="p">,</span> <span class="n">InOutArgument</span><span class="p">)):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">return</span> <span class="n">code_list</span>

    <span class="k">def</span> <span class="nf">_declare_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_declare_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_declare_locals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_routine_ending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="c1"># Note: name not result_var; want `y` not `y[i]` for Indexed</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;unexpected object in Routine results&quot;</span><span class="p">)</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;return &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">end</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_call_printer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">declarations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">result_var</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;unexpected object in Routine results&quot;</span><span class="p">)</span>

            <span class="n">constants</span><span class="p">,</span> <span class="n">not_supported</span><span class="p">,</span> <span class="n">jl_expr</span> <span class="o">=</span> <span class="n">julia_code</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">assign_to</span><span class="o">=</span><span class="n">assign_to</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">declarations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">not_supported</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">func</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">declarations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;# unsupported: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jl_expr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">declarations</span> <span class="o">+</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_indent_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codelines</span><span class="p">):</span>
        <span class="c1"># Note that indenting seems to happen twice, first</span>
        <span class="c1"># statement-by-statement by JuliaPrinter then again here.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">JuliaCodePrinter</span><span class="p">({</span><span class="s1">&#39;human&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">indent_code</span><span class="p">(</span><span class="n">codelines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">codelines</span>

<div class="viewcode-block" id="JuliaCodeGen.dump_jl"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.JuliaCodeGen.dump_jl">[docs]</a>    <span class="k">def</span> <span class="nf">dump_jl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_code</span><span class="p">(</span><span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span>
</div>
    <span class="n">dump_jl</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">code_extension</span>
    <span class="n">dump_jl</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">CodeGen</span><span class="o">.</span><span class="n">dump_code</span><span class="o">.</span><span class="n">__doc__</span>

    <span class="c1"># This list of dump functions is used by CodeGen.write to know which dump</span>
    <span class="c1"># functions it has to call.</span>
    <span class="n">dump_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">dump_jl</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="OctaveCodeGen"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.OctaveCodeGen">[docs]</a><span class="k">class</span> <span class="nc">OctaveCodeGen</span><span class="p">(</span><span class="n">CodeGen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for Octave code.</span>

<span class="sd">    The .write() method inherited from CodeGen will output a code file</span>
<span class="sd">    &lt;prefix&gt;.m.</span>

<span class="sd">    Octave .m files usually contain one function.  That function name should</span>
<span class="sd">    match the filename (``prefix``).  If you pass multiple ``name_expr`` pairs,</span>
<span class="sd">    the latter ones are presumed to be private functions accessed by the</span>
<span class="sd">    primary function.</span>

<span class="sd">    You should only pass inputs to ``argument_sequence``: outputs are ordered</span>
<span class="sd">    according to their order in ``name_expr``.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">code_extension</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>

<div class="viewcode-block" id="OctaveCodeGen.routine"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.OctaveCodeGen.routine">[docs]</a>    <span class="k">def</span> <span class="nf">routine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specialized Routine creation for Octave.&quot;&quot;&quot;</span>

        <span class="c1"># FIXME: this is probably general enough for other high-level</span>
        <span class="c1"># languages, perhaps its the C/Fortran one that is specialized!</span>

        <span class="k">if</span> <span class="n">is_sequence</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">MatrixBase</span><span class="p">,</span> <span class="n">MatrixExpr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No expression given&quot;</span><span class="p">)</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="c1"># local variables</span>
        <span class="n">local_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Idx</span><span class="p">)])</span>

        <span class="c1"># global variables</span>
        <span class="n">global_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">global_vars</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">global_vars</span><span class="p">)</span>

        <span class="c1"># symbols that should be arguments</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">expressions</span><span class="o">.</span><span class="n">free_symbols</span> <span class="o">-</span> <span class="n">local_vars</span> <span class="o">-</span> <span class="n">global_vars</span>

        <span class="c1"># Octave supports multiple return values</span>
        <span class="n">return_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expressions</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Equality</span><span class="p">):</span>
                <span class="n">out_arg</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rhs</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="n">Indexed</span><span class="p">):</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">out_arg</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">label</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_arg</span><span class="p">,</span> <span class="p">(</span><span class="n">Indexed</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">MatrixSymbol</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Only Indexed, Symbol, or MatrixSymbol &quot;</span>
                                       <span class="s2">&quot;can define output arguments.&quot;</span><span class="p">)</span>

                <span class="n">return_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">result_var</span><span class="o">=</span><span class="n">out_arg</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
                    <span class="c1"># this is a pure output: remove from the symbols list, so</span>
                    <span class="c1"># it doesn&#39;t become an input.</span>
                    <span class="n">symbols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we have no name for this output</span>
                <span class="n">return_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Result</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># setup input argument list</span>
        <span class="n">arg_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">array_symbols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">Indexed</span><span class="p">):</span>
            <span class="n">array_symbols</span><span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">MatrixSymbol</span><span class="p">):</span>
            <span class="n">array_symbols</span><span class="p">[</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">argument_sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># if the user has supplied IndexedBase instances, we&#39;ll accept that</span>
            <span class="n">new_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">IndexedBase</span><span class="p">):</span>
                    <span class="n">new_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">argument_sequence</span> <span class="o">=</span> <span class="n">new_sequence</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg_list</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Argument list didn&#39;t specify: {0} &quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]))</span>
                <span class="k">raise</span> <span class="n">CodeGenArgumentListError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>

            <span class="c1"># create redundant arguments to produce the requested sequence</span>
            <span class="n">name_arg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg_list</span><span class="p">])</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">argument_sequence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_arg_dict</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputArgument</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="n">new_args</span>

        <span class="k">return</span> <span class="n">Routine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">,</span> <span class="n">return_vals</span><span class="p">,</span> <span class="n">local_vars</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the symbol appropriately.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">octave_code</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a common header for the generated files.&quot;&quot;&quot;</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">header_comment</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">sympy_version</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2">   </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_preprocessor_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_routine_opening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the opening statements of the routine.&quot;&quot;&quot;</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;function &quot;</span><span class="p">)</span>

        <span class="c1"># Outputs</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="c1"># Note: name not result_var; want `y` not `y(i)` for Indexed</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;unexpected object in Routine results&quot;</span><span class="p">)</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outs</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outs</span><span class="p">))</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">)</span>

        <span class="c1"># Inputs</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">OutputArgument</span><span class="p">,</span> <span class="n">InOutArgument</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;Octave: invalid argument of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">InputArgument</span><span class="p">):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">code_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_list</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">return</span> <span class="n">code_list</span>

    <span class="k">def</span> <span class="nf">_declare_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_declare_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">routine</span><span class="o">.</span><span class="n">global_vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_symbol</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">routine</span><span class="o">.</span><span class="n">global_vars</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;global &quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_declare_locals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_routine_ending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;end</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_call_printer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">):</span>
        <span class="n">declarations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">routine</span><span class="o">.</span><span class="n">results</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                <span class="n">assign_to</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">result_var</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CodeGenError</span><span class="p">(</span><span class="s2">&quot;unexpected object in Routine results&quot;</span><span class="p">)</span>

            <span class="n">constants</span><span class="p">,</span> <span class="n">not_supported</span><span class="p">,</span> <span class="n">oct_expr</span> <span class="o">=</span> <span class="n">octave_code</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">assign_to</span><span class="o">=</span><span class="n">assign_to</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">declarations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">;  </span><span class="si">%%</span><span class="s2"> constant</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">not_supported</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">func</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">declarations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;  </span><span class="si">%%</span><span class="s2"> unsupported: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oct_expr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">declarations</span> <span class="o">+</span> <span class="n">code_lines</span>

    <span class="k">def</span> <span class="nf">_indent_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codelines</span><span class="p">):</span>
        <span class="c1"># Note that indenting seems to happen twice, first</span>
        <span class="c1"># statement-by-statement by OctavePrinter then again here.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">OctaveCodePrinter</span><span class="p">({</span><span class="s1">&#39;human&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">indent_code</span><span class="p">(</span><span class="n">codelines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">codelines</span>

<div class="viewcode-block" id="OctaveCodeGen.dump_m"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.OctaveCodeGen.dump_m">[docs]</a>    <span class="k">def</span> <span class="nf">dump_m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routines</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># Note used to call self.dump_code() but we need more control for header</span>

        <span class="n">code_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor_statements</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">routine</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">routines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                    <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_routine_opening</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">routine</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">prefix</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Octave function name should match prefix&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span>
                                      <span class="s2">&quot;  Autogenerated by sympy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_header</span><span class="p">()))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_arguments</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_globals</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_locals</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_printer</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_routine_ending</span><span class="p">(</span><span class="n">routine</span><span class="p">))</span>

        <span class="n">code_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent_code</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_lines</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">code_lines</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code_lines</span><span class="p">)</span>
</div>
    <span class="n">dump_m</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">code_extension</span>
    <span class="n">dump_m</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">CodeGen</span><span class="o">.</span><span class="n">dump_code</span><span class="o">.</span><span class="n">__doc__</span>

    <span class="c1"># This list of dump functions is used by CodeGen.write to know which dump</span>
    <span class="c1"># functions it has to call.</span>
    <span class="n">dump_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">dump_m</span><span class="p">]</span>

</div>
<span class="k">def</span> <span class="nf">get_code_generator</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
    <span class="n">CodeGenClass</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">CCodeGen</span><span class="p">,</span> <span class="s2">&quot;F95&quot;</span><span class="p">:</span> <span class="n">FCodeGen</span><span class="p">,</span> <span class="s2">&quot;JULIA&quot;</span><span class="p">:</span> <span class="n">JuliaCodeGen</span><span class="p">,</span>
                    <span class="s2">&quot;OCTAVE&quot;</span><span class="p">:</span> <span class="n">OctaveCodeGen</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">language</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">CodeGenClass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Language &#39;</span><span class="si">%s</span><span class="s2">&#39; is not supported.&quot;</span> <span class="o">%</span> <span class="n">language</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CodeGenClass</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Friendly functions</span>
<span class="c1">#</span>


<div class="viewcode-block" id="codegen"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.codegen">[docs]</a><span class="k">def</span> <span class="nf">codegen</span><span class="p">(</span><span class="n">name_expr</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s2">&quot;project&quot;</span><span class="p">,</span>
            <span class="n">to_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">global_vars</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate source code for expressions in a given language.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    name_expr : tuple, or list of tuples</span>
<span class="sd">        A single (name, expression) tuple or a list of (name, expression)</span>
<span class="sd">        tuples.  Each tuple corresponds to a routine.  If the expression is</span>
<span class="sd">        an equality (an instance of class Equality) the left hand side is</span>
<span class="sd">        considered an output argument.  If expression is an iterable, then</span>
<span class="sd">        the routine will have multiple outputs.</span>

<span class="sd">    language : string</span>
<span class="sd">        A string that indicates the source code language.  This is case</span>
<span class="sd">        insensitive.  Currently, &#39;C&#39;, &#39;F95&#39; and &#39;Octave&#39; are supported.</span>
<span class="sd">        &#39;Octave&#39; generates code compatible with both Octave and Matlab.</span>

<span class="sd">    prefix : string, optional</span>
<span class="sd">        A prefix for the names of the files that contain the source code.</span>
<span class="sd">        Language-dependent suffixes will be appended.  If omitted, the name</span>
<span class="sd">        of the first name_expr tuple is used.</span>

<span class="sd">    project : string, optional</span>
<span class="sd">        A project name, used for making unique preprocessor instructions.</span>
<span class="sd">        [default: &quot;project&quot;]</span>

<span class="sd">    to_files : bool, optional</span>
<span class="sd">        When True, the code will be written to one or more files with the</span>
<span class="sd">        given prefix, otherwise strings with the names and contents of</span>
<span class="sd">        these files are returned. [default: False]</span>

<span class="sd">    header : bool, optional</span>
<span class="sd">        When True, a header is written on top of each source file.</span>
<span class="sd">        [default: True]</span>

<span class="sd">    empty : bool, optional</span>
<span class="sd">        When True, empty lines are used to structure the code.</span>
<span class="sd">        [default: True]</span>

<span class="sd">    argument_sequence : iterable, optional</span>
<span class="sd">        Sequence of arguments for the routine in a preferred order.  A</span>
<span class="sd">        CodeGenError is raised if required arguments are missing.</span>
<span class="sd">        Redundant arguments are used without warning.  If omitted,</span>
<span class="sd">        arguments will be ordered alphabetically, but with all input</span>
<span class="sd">        aguments first, and then output or in-out arguments.</span>

<span class="sd">    global_vars : iterable, optional</span>
<span class="sd">        Sequence of global variables used by the routine.  Variables</span>
<span class="sd">        listed here will not show up as function arguments.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.utilities.codegen import codegen</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y, z</span>
<span class="sd">    &gt;&gt;&gt; [(c_name, c_code), (h_name, c_header)] = codegen(</span>
<span class="sd">    ...     (&quot;f&quot;, x+y*z), &quot;C&quot;, &quot;test&quot;, header=False, empty=False)</span>
<span class="sd">    &gt;&gt;&gt; print(c_name)</span>
<span class="sd">    test.c</span>
<span class="sd">    &gt;&gt;&gt; print(c_code)</span>
<span class="sd">    #include &quot;test.h&quot;</span>
<span class="sd">    #include &lt;math.h&gt;</span>
<span class="sd">    double f(double x, double y, double z) {</span>
<span class="sd">      double f_result;</span>
<span class="sd">      f_result = x + y*z;</span>
<span class="sd">      return f_result;</span>
<span class="sd">    }</span>
<span class="sd">    &gt;&gt;&gt; print(h_name)</span>
<span class="sd">    test.h</span>
<span class="sd">    &gt;&gt;&gt; print(c_header)</span>
<span class="sd">    #ifndef PROJECT__TEST__H</span>
<span class="sd">    #define PROJECT__TEST__H</span>
<span class="sd">    double f(double x, double y, double z);</span>
<span class="sd">    #endif</span>

<span class="sd">    Another example using Equality objects to give named outputs.  Here the</span>
<span class="sd">    filename (prefix) is taken from the first (name, expr) pair.</span>

<span class="sd">    &gt;&gt;&gt; from sympy.abc import f, g</span>
<span class="sd">    &gt;&gt;&gt; from sympy import Eq</span>
<span class="sd">    &gt;&gt;&gt; [(c_name, c_code), (h_name, c_header)] = codegen(</span>
<span class="sd">    ...      [(&quot;myfcn&quot;, x + y), (&quot;fcn2&quot;, [Eq(f, 2*x), Eq(g, y)])],</span>
<span class="sd">    ...      &quot;C&quot;, header=False, empty=False)</span>
<span class="sd">    &gt;&gt;&gt; print(c_name)</span>
<span class="sd">    myfcn.c</span>
<span class="sd">    &gt;&gt;&gt; print(c_code)</span>
<span class="sd">    #include &quot;myfcn.h&quot;</span>
<span class="sd">    #include &lt;math.h&gt;</span>
<span class="sd">    double myfcn(double x, double y) {</span>
<span class="sd">       double myfcn_result;</span>
<span class="sd">       myfcn_result = x + y;</span>
<span class="sd">       return myfcn_result;</span>
<span class="sd">    }</span>
<span class="sd">    void fcn2(double x, double y, double *f, double *g) {</span>
<span class="sd">       (*f) = 2*x;</span>
<span class="sd">       (*g) = y;</span>
<span class="sd">    }</span>

<span class="sd">    If the generated function(s) will be part of a larger project where various</span>
<span class="sd">    global variables have been defined, the &#39;global_vars&#39; option can be used</span>
<span class="sd">    to remove the specified variables from the function signature</span>

<span class="sd">    &gt;&gt;&gt; from sympy.utilities.codegen import codegen</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y, z</span>
<span class="sd">    &gt;&gt;&gt; [(f_name, f_code), header] = codegen(</span>
<span class="sd">    ...     (&quot;f&quot;, x+y*z), &quot;F95&quot;, header=False, empty=False,</span>
<span class="sd">    ...     argument_sequence=(x, y), global_vars=(z,))</span>
<span class="sd">    &gt;&gt;&gt; print(f_code)</span>
<span class="sd">    REAL*8 function f(x, y)</span>
<span class="sd">    implicit none</span>
<span class="sd">    REAL*8, intent(in) :: x</span>
<span class="sd">    REAL*8, intent(in) :: y</span>
<span class="sd">    f = x + y*z</span>
<span class="sd">    end function</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize the code generator.</span>
    <span class="n">code_gen</span> <span class="o">=</span> <span class="n">get_code_generator</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_expr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="c1"># single tuple is given, turn it into a singleton list with a tuple.</span>
        <span class="n">name_expr</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_expr</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">name_expr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Construct Routines appropriate for this code_gen from (name, expr) pairs.</span>
    <span class="n">routines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">name_expr</span><span class="p">:</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code_gen</span><span class="o">.</span><span class="n">routine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="p">,</span>
                                         <span class="n">global_vars</span><span class="p">))</span>

    <span class="c1"># Write the code.</span>
    <span class="k">return</span> <span class="n">code_gen</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">routines</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">to_files</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="make_routine"><a class="viewcode-back" href="../../../modules/utilities/codegen.html#sympy.utilities.codegen.make_routine">[docs]</a><span class="k">def</span> <span class="nf">make_routine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">global_vars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;F95&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A factory that makes an appropriate Routine from an expression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    name : string</span>
<span class="sd">        The name of this routine in the generated code.</span>

<span class="sd">    expr : expression or list/tuple of expressions</span>
<span class="sd">        A SymPy expression that the Routine instance will represent.  If</span>
<span class="sd">        given a list or tuple of expressions, the routine will be</span>
<span class="sd">        considered to have multiple return values and/or output arguments.</span>

<span class="sd">    argument_sequence : list or tuple, optional</span>
<span class="sd">        List arguments for the routine in a preferred order.  If omitted,</span>
<span class="sd">        the results are language dependent, for example, alphabetical order</span>
<span class="sd">        or in the same order as the given expressions.</span>

<span class="sd">    global_vars : iterable, optional</span>
<span class="sd">        Sequence of global variables used by the routine.  Variables</span>
<span class="sd">        listed here will not show up as function arguments.</span>

<span class="sd">    language : string, optional</span>
<span class="sd">        Specify a target language.  The Routine itself should be</span>
<span class="sd">        language-agnostic but the precise way one is created, error</span>
<span class="sd">        checking, etc depend on the language.  [default: &quot;F95&quot;].</span>

<span class="sd">    A decision about whether to use output arguments or return values is made</span>
<span class="sd">    depending on both the language and the particular mathematical expressions.</span>
<span class="sd">    For an expression of type Equality, the left hand side is typically made</span>
<span class="sd">    into an OutputArgument (or perhaps an InOutArgument if appropriate).</span>
<span class="sd">    Otherwise, typically, the calculated expression is made a return values of</span>
<span class="sd">    the routine.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.utilities.codegen import make_routine</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y, f, g</span>
<span class="sd">    &gt;&gt;&gt; from sympy import Eq</span>
<span class="sd">    &gt;&gt;&gt; r = make_routine(&#39;test&#39;, [Eq(f, 2*x), Eq(g, x + y)])</span>
<span class="sd">    &gt;&gt;&gt; [arg.result_var for arg in r.results]</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; [arg.name for arg in r.arguments]</span>
<span class="sd">    [x, y, f, g]</span>
<span class="sd">    &gt;&gt;&gt; [arg.name for arg in r.result_variables]</span>
<span class="sd">    [f, g]</span>
<span class="sd">    &gt;&gt;&gt; r.local_vars</span>
<span class="sd">    set()</span>

<span class="sd">    Another more complicated example with a mixture of specified and</span>
<span class="sd">    automatically-assigned names.  Also has Matrix output.</span>

<span class="sd">    &gt;&gt;&gt; from sympy import Matrix</span>
<span class="sd">    &gt;&gt;&gt; r = make_routine(&#39;fcn&#39;, [x*y, Eq(f, 1), Eq(g, x + g), Matrix([[x, 2]])])</span>
<span class="sd">    &gt;&gt;&gt; [arg.result_var for arg in r.results]  # doctest: +SKIP</span>
<span class="sd">    [result_5397460570204848505]</span>
<span class="sd">    &gt;&gt;&gt; [arg.expr for arg in r.results]</span>
<span class="sd">    [x*y]</span>
<span class="sd">    &gt;&gt;&gt; [arg.name for arg in r.arguments]  # doctest: +SKIP</span>
<span class="sd">    [x, y, f, g, out_8598435338387848786]</span>

<span class="sd">    We can examine the various arguments more closely:</span>

<span class="sd">    &gt;&gt;&gt; from sympy.utilities.codegen import (InputArgument, OutputArgument,</span>
<span class="sd">    ...                                      InOutArgument)</span>
<span class="sd">    &gt;&gt;&gt; [a.name for a in r.arguments if isinstance(a, InputArgument)]</span>
<span class="sd">    [x, y]</span>

<span class="sd">    &gt;&gt;&gt; [a.name for a in r.arguments if isinstance(a, OutputArgument)]  # doctest: +SKIP</span>
<span class="sd">    [f, out_8598435338387848786]</span>
<span class="sd">    &gt;&gt;&gt; [a.expr for a in r.arguments if isinstance(a, OutputArgument)]</span>
<span class="sd">    [1, Matrix([[x, 2]])]</span>

<span class="sd">    &gt;&gt;&gt; [a.name for a in r.arguments if isinstance(a, InOutArgument)]</span>
<span class="sd">    [g]</span>
<span class="sd">    &gt;&gt;&gt; [a.expr for a in r.arguments if isinstance(a, InOutArgument)]</span>
<span class="sd">    [g + x]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize a new code generator</span>
    <span class="n">code_gen</span> <span class="o">=</span> <span class="n">get_code_generator</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="s2">&quot;nothingElseMatters&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">code_gen</span><span class="o">.</span><span class="n">routine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">argument_sequence</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/sympylogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SymPy 1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015 SymPy Development Team.
      Last updated on Mar 08, 2016.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>