
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>sympy.printing.theanocode &#8212; SymPy 1.4.dev documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://live.sympy.org/static/live-core.css" type="text/css" />
    <link rel="stylesheet" href="https://live.sympy.org/static/live-autocomplete.css" type="text/css" />
    <link rel="stylesheet" href="https://live.sympy.org/static/live-sphinx.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full"></script>
    <script type="text/javascript" src="https://live.sympy.org/static/utilities.js"></script>
    <script type="text/javascript" src="https://live.sympy.org/static/external/classy.js"></script>
    <script type="text/javascript" src="https://live.sympy.org/static/live-core.js"></script>
    <script type="text/javascript" src="https://live.sympy.org/static/live-autocomplete.js"></script>
    <script type="text/javascript" src="https://live.sympy.org/static/live-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../_static/sympy-notailtext-favicon.ico"/>
    <link href="http://docs.sympy.org/latest/_modules/sympy/printing/theanocode.html" rel="canonical" />
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SymPy 1.4.dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sympy.printing.theanocode</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">from</span> <span class="nn">sympy.external</span> <span class="k">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">sympy.printing.printer</span> <span class="k">import</span> <span class="n">Printer</span>
<span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="k">import</span> <span class="nb">range</span><span class="p">,</span> <span class="n">is_sequence</span>
<span class="kn">from</span> <span class="nn">sympy.utilities.exceptions</span> <span class="k">import</span> <span class="n">SymPyDeprecationWarning</span>
<span class="kn">import</span> <span class="nn">sympy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>


<span class="n">theano</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;theano&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">theano</span><span class="p">:</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">scalar</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">tensor</span>
    <span class="kn">from</span> <span class="nn">theano.sandbox</span> <span class="k">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">tlinalg</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Add</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Mul</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Abs</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">abs_</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">sign</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">sgn</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">ceiling</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">ceil</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">floor</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">log</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">exp</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">cos</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">acos</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arccos</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">sin</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">asin</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arcsin</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">tan</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">atan</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">atan2</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arctan2</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">cosh</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">cosh</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">acosh</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arccosh</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">sinh</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">sinh</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">asinh</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">tanh</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">atanh</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">arctanh</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">re</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">im</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">arg</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">erf</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">erf</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">gamma</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">loggamma</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">gammaln</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Pow</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">pow</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Eq</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">StrictGreaterThan</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">StrictLessThan</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">LessThan</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">GreaterThan</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">And</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Or</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Max</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span>  <span class="c1"># Sympy accept &gt;2 inputs, Theano only 2</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Min</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span>  <span class="c1"># Sympy accept &gt;2 inputs, Theano only 2</span>
            <span class="c1"># Matrices</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">MatAdd</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">Elemwise</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">),</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">HadamardProduct</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">Elemwise</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">mul</span><span class="p">),</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Trace</span><span class="p">:</span> <span class="n">tlinalg</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Determinant</span> <span class="p">:</span> <span class="n">tlinalg</span><span class="o">.</span><span class="n">det</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Inverse</span><span class="p">:</span> <span class="n">tlinalg</span><span class="o">.</span><span class="n">matrix_inverse</span><span class="p">,</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Transpose</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">DimShuffle</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
    <span class="p">}</span>


<div class="viewcode-block" id="TheanoPrinter"><a class="viewcode-back" href="../../../modules/printing.html#sympy.printing.theanocode.TheanoPrinter">[docs]</a><span class="k">class</span> <span class="nc">TheanoPrinter</span><span class="p">(</span><span class="n">Printer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Code printer which creates Theano symbolic expression graphs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    cache : dict</span>
<span class="sd">        Cache dictionary to use (see :attr:`cache`). If None (default) will use</span>
<span class="sd">        the global cache. To create a printer which does not depend on or alter</span>
<span class="sd">        global state pass an empty dictionary. Note: the dictionary is not</span>
<span class="sd">        copied on initialization of the printer and will be updated in-place,</span>
<span class="sd">        so using the same dict object when creating multiple printers or making</span>
<span class="sd">        multiple calls to :func:`.theano_code` or :func:`.theano_function` means</span>
<span class="sd">        the cache is shared between all these applications.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ==========</span>

<span class="sd">    cache : dict</span>
<span class="sd">        A cache of Theano variables which have been created for Sympy</span>
<span class="sd">        symbol-like objects (e.g. :class:`sympy.core.symbol.Symbol` or</span>
<span class="sd">        :class:`sympy.matrices.expressions.MatrixSymbol`). This is used to</span>
<span class="sd">        ensure that all references to a given symbol in an expression (or</span>
<span class="sd">        multiple expressions) are printed as the same Theano variable, which is</span>
<span class="sd">        created only once. Symbols are differentiated only by name and type. The</span>
<span class="sd">        format of the cache&#39;s contents should be considered opaque to the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">printmethod</span> <span class="o">=</span> <span class="s2">&quot;_theano&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TheanoPrinter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the cache key for a Sympy object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        s : sympy.core.basic.Basic</span>
<span class="sd">            Sympy object to get key for.</span>

<span class="sd">        name : str</span>
<span class="sd">            Name of object, if it does not have a ``name`` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">broadcastable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Theano variable for a Sympy symbol from the cache, or create it</span>
<span class="sd">        if it does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Defaults</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;floatX&#39;</span>
        <span class="k">if</span> <span class="n">broadcastable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">broadcastable</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="n">broadcastable</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="n">broadcastable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_print_Symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtypes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;broadcastables&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="n">bc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_AppliedUndef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtypes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;broadcastables&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="n">bc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_Basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)]</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_Number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Integers already taken care of below, interpret as float</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">evalf</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_print_MatrixSymbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtypes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">broadcastable</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_DenseMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tt</span><span class="o">.</span><span class="n">stacklists</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
               <span class="s2">&quot;Matrix translation not yet supported in this version of Theano&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">stacklists</span><span class="p">([</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">L</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">])</span>

    <span class="n">_print_ImmutableMatrix</span> <span class="o">=</span> <span class="n">_print_ImmutableDenseMatrix</span> <span class="o">=</span> <span class="n">_print_DenseMatrix</span>

    <span class="k">def</span> <span class="nf">_print_MatMul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_print_MatrixSlice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">rowslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">rowslice</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">colslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">colslice</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent</span><span class="p">[</span><span class="n">rowslice</span><span class="p">,</span> <span class="n">colslice</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_print_BlockMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_print_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Basic</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">step</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_print_Pi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">3.141592653589793</span>

    <span class="k">def</span> <span class="nf">_print_Piecewise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span>  <span class="c1"># First condition and corresponding value</span>

        <span class="c1"># Print conditional expression and value for first condition</span>
        <span class="n">p_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">p_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># One condition only</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Return value if condition else NaN</span>
            <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">p_cond</span><span class="p">,</span> <span class="n">p_e</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Return value_1 if condition_1 else evaluate remaining conditions</span>
        <span class="n">p_remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">sympy</span><span class="o">.</span><span class="n">Piecewise</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">p_cond</span><span class="p">,</span> <span class="n">p_e</span><span class="p">,</span> <span class="n">p_remaining</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_Rational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">true_div</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_Integer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">p</span>

    <span class="k">def</span> <span class="nf">_print_factorial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">sympy</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_Derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deriv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">deriv</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">deriv</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">Rop</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">emptyPrinter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>

<div class="viewcode-block" id="TheanoPrinter.doprint"><a class="viewcode-back" href="../../../modules/printing.html#sympy.printing.theanocode.TheanoPrinter.doprint">[docs]</a>    <span class="k">def</span> <span class="nf">doprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">broadcastables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert a Sympy expression to a Theano graph variable.</span>

<span class="sd">        The ``dtypes`` and ``broadcastables`` arguments are used to specify the</span>
<span class="sd">        data type, dimension, and broadcasting behavior of the Theano variables</span>
<span class="sd">        corresponding to the free symbols in ``expr``. Each is a mapping from</span>
<span class="sd">        Sympy symbols to the value of the corresponding argument to</span>
<span class="sd">        :func:`theano.tensor.Tensor`.</span>

<span class="sd">        See the corresponding `documentation page`__ for more information on</span>
<span class="sd">        broadcasting in Theano.</span>

<span class="sd">        .. __: http://deeplearning.net/software/theano/tutorial/broadcasting.html</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        expr : sympy.core.expr.Expr</span>
<span class="sd">            Sympy expression to print.</span>

<span class="sd">        dtypes : dict</span>
<span class="sd">            Mapping from Sympy symbols to Theano datatypes to use when creating</span>
<span class="sd">            new Theano variables for those symbols. Corresponds to the ``dtype``</span>
<span class="sd">            argument to :func:`theano.tensor.Tensor`. Defaults to ``&#39;floatX&#39;``</span>
<span class="sd">            for symbols not included in the mapping.</span>

<span class="sd">        broadcastables : dict</span>
<span class="sd">            Mapping from Sympy symbols to the value of the ``broadcastable``</span>
<span class="sd">            argument to :func:`theano.tensor.Tensor` to use when creating Theano</span>
<span class="sd">            variables for those symbols. Defaults to the empty tuple for symbols</span>
<span class="sd">            not included in the mapping (resulting in a scalar).</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>

<span class="sd">        theano.gof.graph.Variable</span>
<span class="sd">            A variable corresponding to the expression&#39;s value in a Theano</span>
<span class="sd">            symbolic expression graph.</span>

<span class="sd">        See Also</span>
<span class="sd">        ========</span>
<span class="sd">        theano.tensor.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">broadcastables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">broadcastables</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">broadcastables</span><span class="o">=</span><span class="n">broadcastables</span><span class="p">)</span></div></div>


<span class="n">global_cache</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="theano_code"><a class="viewcode-back" href="../../../modules/printing.html#sympy.printing.theanocode.theano_code">[docs]</a><span class="k">def</span> <span class="nf">theano_code</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert a Sympy expression into a Theano graph variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    expr : sympy.core.expr.Expr</span>
<span class="sd">        Sympy expression object to convert.</span>

<span class="sd">    cache : dict</span>
<span class="sd">       Cached Theano variables (see :attr:`.TheanoPrinter.cache`). Defaults to</span>
<span class="sd">       the module-level global cache.</span>

<span class="sd">    dtypes : dict</span>
<span class="sd">        Passed to :meth:`.TheanoPrinter.doprint`.</span>

<span class="sd">    broadcastables : dict</span>
<span class="sd">        Passed to :meth:`.TheanoPrinter.doprint`.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>

<span class="sd">    theano.gof.graph.Variable</span>
<span class="sd">        A variable corresponding to the expression&#39;s value in a Theano symbolic</span>
<span class="sd">        expression graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">theano</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;theano is required for theano_code&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">global_cache</span>

    <span class="k">return</span> <span class="n">TheanoPrinter</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{})</span><span class="o">.</span><span class="n">doprint</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">dim_handling</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">broadcastables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get value of ``broadcastables`` argument to :func:`.theano_code` from</span>
<span class="sd">    keyword arguments to :func:`.theano_function`.</span>

<span class="sd">    Included for backwards compatibility.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    inputs</span>
<span class="sd">        Sequence of input symbols.</span>

<span class="sd">    dim : int</span>
<span class="sd">        Common number of dimensions for all inputs. Overrides other arguments</span>
<span class="sd">        if given.</span>

<span class="sd">    dims : dict</span>
<span class="sd">        Mapping from input symbols to number of dimensions. Overrides</span>
<span class="sd">        ``broadcastables`` argument if given.</span>

<span class="sd">    broadcastables : dict</span>
<span class="sd">        Explicit value of ``broadcastables`` argument to</span>
<span class="sd">        :meth:`.TheanoPrinter.doprint`. If not None function will return this value unchanged.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping elements of ``inputs`` to their &quot;broadcastable&quot;</span>
<span class="sd">        values (tuple of ``bool``s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dim</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxdim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dims</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,)</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="kc">True</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxdim</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">broadcastables</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">broadcastables</span>

    <span class="k">return</span> <span class="p">{}</span>


<div class="viewcode-block" id="theano_function"><a class="viewcode-back" href="../../../modules/printing.html#sympy.printing.theanocode.theano_function">[docs]</a><span class="k">def</span> <span class="nf">theano_function</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a Theano function from SymPy expressions.</span>

<span class="sd">    The inputs and outputs are converted to Theano variables using</span>
<span class="sd">    :func:`.theano_code` and then passed to :func:`theano.function`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    inputs</span>
<span class="sd">        Sequence of symbols which constitute the inputs of the function.</span>

<span class="sd">    outputs</span>
<span class="sd">        Expression or sequence of expressions which constitute the outputs(s) of</span>
<span class="sd">        the function. The free symbols of each expression must be a subset of</span>
<span class="sd">        ``inputs``.</span>

<span class="sd">    squeeze : bool</span>
<span class="sd">        If ``outputs`` is a sequence of length one, pass the printed value of</span>
<span class="sd">        the lone element of the sequence to :func:`theano.function` instead of</span>
<span class="sd">        the sequence itself. This has the effect of making a function which</span>
<span class="sd">        returns a single array instead of a list containing one array. This</span>
<span class="sd">        behavior is deprecated and the default value will be changed to False in</span>
<span class="sd">        a future release. To get a function that returns a single</span>

<span class="sd">    scalar : bool</span>
<span class="sd">        Convert 0-dimensional arrays in output to scalars. This will return a</span>
<span class="sd">        Python wrapper function around the Theano function object.</span>

<span class="sd">    cache : dict</span>
<span class="sd">       Cached Theano variables (see :attr:`.TheanoPrinter.cache`). Defaults to</span>
<span class="sd">       the module-level global cache.</span>

<span class="sd">    dtypes : dict</span>
<span class="sd">        Passed to :meth:`.TheanoPrinter.doprint`.</span>

<span class="sd">    broadcastables : dict</span>
<span class="sd">        Passed to :meth:`.TheanoPrinter.doprint`.</span>

<span class="sd">    dims : dict</span>
<span class="sd">        Alternative to ``broadcastables`` argument. Mapping from elements of</span>
<span class="sd">        ``inputs`` to integers indicating the dimension of their associated</span>
<span class="sd">        arrays/tensors. Overrides ``broadcastables`` argument if given.</span>

<span class="sd">    dim : int</span>
<span class="sd">        Another alternative to the ``broadcastables`` argument. Common number of</span>
<span class="sd">        dimensions to use for all arrays/tensors.</span>
<span class="sd">        ``theano_function([x, y], [...], dim=2)`` is equivalent to using</span>
<span class="sd">        ``broadcastables={x: (False, False), y: (False, False)}``.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    callable</span>
<span class="sd">        A callable object which takes values of ``inputs`` as positional</span>
<span class="sd">        arguments and returns an output array for each of the expressions</span>
<span class="sd">        in ``outputs``. If ``outputs`` is a single expression the function will</span>
<span class="sd">        return a Numpy array, if it is a list of multiple expressions the</span>
<span class="sd">        function will return a list of arrays. See description of the ``squeeze``</span>
<span class="sd">        argument above for the behavior when a single output is passed in a list.</span>
<span class="sd">        The returned object will either be an instance of</span>
<span class="sd">        :class:`theano.compile.function_module.Function` or a Python wrapper</span>
<span class="sd">        function around one. In both cases, the returned value will have a</span>
<span class="sd">        ``theano_function`` attribute which points to the return value of</span>
<span class="sd">        :func:`theano.function`.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y, z</span>
<span class="sd">    &gt;&gt;&gt; from sympy.printing.theanocode import theano_function</span>

<span class="sd">    A simple function with one input and one output:</span>

<span class="sd">    &gt;&gt;&gt; f1 = theano_function([x], x**2 - 1, scalar=True)</span>
<span class="sd">    &gt;&gt;&gt; f1(3)</span>
<span class="sd">    8.0</span>

<span class="sd">    A function with multiple inputs and one output:</span>

<span class="sd">    &gt;&gt;&gt; f2 = theano_function([x, y, z], (x**z + y**z)**(1/z), scalar=True)</span>
<span class="sd">    &gt;&gt;&gt; f2(3, 4, 2)</span>
<span class="sd">    5.0</span>

<span class="sd">    A function with multiple inputs and multiple outputs:</span>

<span class="sd">    &gt;&gt;&gt; f3 = theano_function([x, y], [x**2 + y**2, x**2 - y**2], scalar=True)</span>
<span class="sd">    &gt;&gt;&gt; f3(2, 3)</span>
<span class="sd">    [13.0, -5.0]</span>

<span class="sd">    See also</span>
<span class="sd">    ========</span>
<span class="sd">    theano.function</span>
<span class="sd">    dim_handling</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">theano</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;theano is required for theano_function&quot;</span><span class="p">)</span>

    <span class="c1"># Squeeze output sequence of length one</span>
    <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">and</span> <span class="n">is_sequence</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">SymPyDeprecationWarning</span><span class="p">(</span>
            <span class="n">feature</span><span class="o">=</span><span class="s1">&#39;theano_function() with squeeze=True&#39;</span><span class="p">,</span>
            <span class="n">issue</span><span class="o">=</span><span class="mi">14986</span><span class="p">,</span>
            <span class="n">deprecated_since_version</span><span class="o">=</span><span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span>
            <span class="n">useinstead</span><span class="o">=</span><span class="s1">&#39;a single expression as &quot;outputs&quot; (not a list)&#39;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">warn</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Pop off non-theano keyword args</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dtypes&#39;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">broadcastables</span> <span class="o">=</span> <span class="n">dim_handling</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">,</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">broadcastables</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;broadcastables&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Print inputs/outputs</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">theano_code</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dtypes</span><span class="p">,</span>
                   <span class="n">broadcastables</span><span class="o">=</span><span class="n">broadcastables</span><span class="p">)</span>
    <span class="n">tinputs</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">inputs</span><span class="p">))</span>

    <span class="n">is_seq</span> <span class="o">=</span> <span class="n">is_sequence</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_seq</span><span class="p">:</span>
        <span class="n">toutputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">outputs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">toutputs</span> <span class="o">=</span> <span class="n">code</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

    <span class="c1"># Compile theano func</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">tinputs</span><span class="p">,</span> <span class="n">toutputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">is_0d</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">broadcastable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">outputs</span><span class="p">]</span>

    <span class="c1"># No wrapper required</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scalar</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_0d</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">theano_function</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="c1"># Create wrapper to convert 0-dimensional outputs to scalars</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_seq</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">[()]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">o</span><span class="p">[()]</span> <span class="k">if</span> <span class="n">is_0d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">o</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>

    <span class="n">wrapper</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">=</span> <span class="n">func</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">theano_function</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/sympylogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SymPy 1.4.dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018 SymPy Development Team.
      Last updated on Sep 11, 2018.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.
    </div>
  </body>
</html>